var He=Object.defineProperty,Ge=Object.defineProperties;var Ye=Object.getOwnPropertyDescriptors;var ge=Object.getOwnPropertySymbols;var Be=Object.prototype.hasOwnProperty,Ze=Object.prototype.propertyIsEnumerable;var we=(M,s,R)=>s in M?He(M,s,{enumerable:!0,configurable:!0,writable:!0,value:R}):M[s]=R,be=(M,s)=>{for(var R in s||(s={}))Be.call(s,R)&&we(M,R,s[R]);if(ge)for(var R of ge(s))Ze.call(s,R)&&we(M,R,s[R]);return M},Ee=(M,s)=>Ge(M,Ye(s));(function(M,s){typeof exports=="object"&&typeof module!="undefined"?s(exports,require("three"),require("molang"),require("wintersky")):typeof define=="function"&&define.amd?define(["exports","three","molang","wintersky"],s):(M=typeof globalThis!="undefined"?globalThis:M||self,s(M.ModelViewer={},M.three,M.molang,M.Wintersky))})(this,function(M,s,R,ye){"use strict";function Te(x){return x&&typeof x=="object"&&"default"in x?x:{default:x}}var Me=Te(ye);const J={type:"change"},W={type:"start"},K={type:"end"};class Ae extends s.EventDispatcher{constructor(o,n){super();n===void 0&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),n===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=o,this.domElement=n,this.enabled=!0,this.target=new s.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:s.MOUSE.ROTATE,MIDDLE:s.MOUSE.DOLLY,RIGHT:s.MOUSE.PAN},this.touches={ONE:s.TOUCH.ROTATE,TWO:s.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.listenToKeyEvents=function(t){t.addEventListener("keydown",le),this._domElementKeyEvents=t},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(J),e.update(),a=i.NONE},this.update=function(){const t=new s.Vector3,h=new s.Quaternion().setFromUnitVectors(o.up,new s.Vector3(0,1,0)),T=h.clone().invert(),k=new s.Vector3,I=new s.Quaternion,G=2*Math.PI;return function(){const fe=e.object.position;t.copy(fe).sub(e.target),t.applyQuaternion(h),r.setFromVector3(t),e.autoRotate&&a===i.NONE&&p(H()),e.enableDamping?(r.theta+=l.theta*e.dampingFactor,r.phi+=l.phi*e.dampingFactor):(r.theta+=l.theta,r.phi+=l.phi);let S=e.minAzimuthAngle,_=e.maxAzimuthAngle;return isFinite(S)&&isFinite(_)&&(S<-Math.PI?S+=G:S>Math.PI&&(S-=G),_<-Math.PI?_+=G:_>Math.PI&&(_-=G),S<=_?r.theta=Math.max(S,Math.min(_,r.theta)):r.theta=r.theta>(S+_)/2?Math.max(S,r.theta):Math.min(_,r.theta)),r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi)),r.makeSafe(),r.radius*=d,r.radius=Math.max(e.minDistance,Math.min(e.maxDistance,r.radius)),e.enableDamping===!0?e.target.addScaledVector(c,e.dampingFactor):e.target.add(c),t.setFromSpherical(r),t.applyQuaternion(T),fe.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(l.theta*=1-e.dampingFactor,l.phi*=1-e.dampingFactor,c.multiplyScalar(1-e.dampingFactor)):(l.set(0,0,0),c.set(0,0,0)),d=1,w||k.distanceToSquared(e.object.position)>g||8*(1-I.dot(e.object.quaternion))>g?(e.dispatchEvent(J),k.copy(e.object.position),I.copy(e.object.quaternion),w=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",pe),e.domElement.removeEventListener("pointerdown",ce),e.domElement.removeEventListener("wheel",ue),e.domElement.removeEventListener("touchstart",he),e.domElement.removeEventListener("touchend",me),e.domElement.removeEventListener("touchmove",de),e.domElement.ownerDocument.removeEventListener("pointermove",$),e.domElement.ownerDocument.removeEventListener("pointerup",Q),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",le)};const e=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let a=i.NONE;const g=1e-6,r=new s.Spherical,l=new s.Spherical;let d=1;const c=new s.Vector3;let w=!1;const f=new s.Vector2,u=new s.Vector2,P=new s.Vector2,b=new s.Vector2,A=new s.Vector2,L=new s.Vector2,v=new s.Vector2,O=new s.Vector2,j=new s.Vector2;function H(){return 2*Math.PI/60/60*e.autoRotateSpeed}function N(){return Math.pow(.95,e.zoomSpeed)}function p(t){l.theta-=t}function E(t){l.phi-=t}const m=function(){const t=new s.Vector3;return function(T,k){t.setFromMatrixColumn(k,0),t.multiplyScalar(-T),c.add(t)}}(),y=function(){const t=new s.Vector3;return function(T,k){e.screenSpacePanning===!0?t.setFromMatrixColumn(k,1):(t.setFromMatrixColumn(k,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(T),c.add(t)}}(),U=function(){const t=new s.Vector3;return function(T,k){const I=e.domElement;if(e.object.isPerspectiveCamera){const G=e.object.position;t.copy(G).sub(e.target);let C=t.length();C*=Math.tan(e.object.fov/2*Math.PI/180),m(2*T*C/I.clientHeight,e.object.matrix),y(2*k*C/I.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(m(T*(e.object.right-e.object.left)/e.object.zoom/I.clientWidth,e.object.matrix),y(k*(e.object.top-e.object.bottom)/e.object.zoom/I.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function D(t){e.object.isPerspectiveCamera?d/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),w=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function F(t){e.object.isPerspectiveCamera?d*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),w=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function V(t){f.set(t.clientX,t.clientY)}function B(t){v.set(t.clientX,t.clientY)}function Y(t){b.set(t.clientX,t.clientY)}function Z(t){u.set(t.clientX,t.clientY),P.subVectors(u,f).multiplyScalar(e.rotateSpeed);const h=e.domElement;p(2*Math.PI*P.x/h.clientHeight),E(2*Math.PI*P.y/h.clientHeight),f.copy(u),e.update()}function q(t){O.set(t.clientX,t.clientY),j.subVectors(O,v),j.y>0?D(N()):j.y<0&&F(N()),v.copy(O),e.update()}function z(t){A.set(t.clientX,t.clientY),L.subVectors(A,b).multiplyScalar(e.panSpeed),U(L.x,L.y),b.copy(A),e.update()}function X(t){t.deltaY<0?F(N()):t.deltaY>0&&D(N()),e.update()}function Ue(t){let h=!1;switch(t.code){case e.keys.UP:U(0,e.keyPanSpeed),h=!0;break;case e.keys.BOTTOM:U(0,-e.keyPanSpeed),h=!0;break;case e.keys.LEFT:U(e.keyPanSpeed,0),h=!0;break;case e.keys.RIGHT:U(-e.keyPanSpeed,0),h=!0;break}h&&(t.preventDefault(),e.update())}function oe(t){if(t.touches.length==1)f.set(t.touches[0].pageX,t.touches[0].pageY);else{const h=.5*(t.touches[0].pageX+t.touches[1].pageX),T=.5*(t.touches[0].pageY+t.touches[1].pageY);f.set(h,T)}}function se(t){if(t.touches.length==1)b.set(t.touches[0].pageX,t.touches[0].pageY);else{const h=.5*(t.touches[0].pageX+t.touches[1].pageX),T=.5*(t.touches[0].pageY+t.touches[1].pageY);b.set(h,T)}}function ne(t){const h=t.touches[0].pageX-t.touches[1].pageX,T=t.touches[0].pageY-t.touches[1].pageY,k=Math.sqrt(h*h+T*T);v.set(0,k)}function je(t){e.enableZoom&&ne(t),e.enablePan&&se(t)}function Se(t){e.enableZoom&&ne(t),e.enableRotate&&oe(t)}function ie(t){if(t.touches.length==1)u.set(t.touches[0].pageX,t.touches[0].pageY);else{const T=.5*(t.touches[0].pageX+t.touches[1].pageX),k=.5*(t.touches[0].pageY+t.touches[1].pageY);u.set(T,k)}P.subVectors(u,f).multiplyScalar(e.rotateSpeed);const h=e.domElement;p(2*Math.PI*P.x/h.clientHeight),E(2*Math.PI*P.y/h.clientHeight),f.copy(u)}function ae(t){if(t.touches.length==1)A.set(t.touches[0].pageX,t.touches[0].pageY);else{const h=.5*(t.touches[0].pageX+t.touches[1].pageX),T=.5*(t.touches[0].pageY+t.touches[1].pageY);A.set(h,T)}L.subVectors(A,b).multiplyScalar(e.panSpeed),U(L.x,L.y),b.copy(A)}function re(t){const h=t.touches[0].pageX-t.touches[1].pageX,T=t.touches[0].pageY-t.touches[1].pageY,k=Math.sqrt(h*h+T*T);O.set(0,k),j.set(0,Math.pow(O.y/v.y,e.zoomSpeed)),D(j.y),v.copy(O)}function _e(t){e.enableZoom&&re(t),e.enablePan&&ae(t)}function De(t){e.enableZoom&&re(t),e.enableRotate&&ie(t)}function ce(t){if(e.enabled!==!1)switch(t.pointerType){case"mouse":case"pen":Ve(t);break}}function $(t){if(e.enabled!==!1)switch(t.pointerType){case"mouse":case"pen":Fe(t);break}}function Q(t){switch(t.pointerType){case"mouse":case"pen":Ie();break}}function Ve(t){t.preventDefault(),e.domElement.focus?e.domElement.focus():window.focus();let h;switch(t.button){case 0:h=e.mouseButtons.LEFT;break;case 1:h=e.mouseButtons.MIDDLE;break;case 2:h=e.mouseButtons.RIGHT;break;default:h=-1}switch(h){case s.MOUSE.DOLLY:if(e.enableZoom===!1)return;B(t),a=i.DOLLY;break;case s.MOUSE.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;Y(t),a=i.PAN}else{if(e.enableRotate===!1)return;V(t),a=i.ROTATE}break;case s.MOUSE.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;V(t),a=i.ROTATE}else{if(e.enablePan===!1)return;Y(t),a=i.PAN}break;default:a=i.NONE}a!==i.NONE&&(e.domElement.ownerDocument.addEventListener("pointermove",$),e.domElement.ownerDocument.addEventListener("pointerup",Q),e.dispatchEvent(W))}function Fe(t){if(e.enabled!==!1)switch(t.preventDefault(),a){case i.ROTATE:if(e.enableRotate===!1)return;Z(t);break;case i.DOLLY:if(e.enableZoom===!1)return;q(t);break;case i.PAN:if(e.enablePan===!1)return;z(t);break}}function Ie(t){e.domElement.ownerDocument.removeEventListener("pointermove",$),e.domElement.ownerDocument.removeEventListener("pointerup",Q),e.enabled!==!1&&(e.dispatchEvent(K),a=i.NONE)}function ue(t){e.enabled===!1||e.enableZoom===!1||a!==i.NONE&&a!==i.ROTATE||(t.preventDefault(),e.dispatchEvent(W),X(t),e.dispatchEvent(K))}function le(t){e.enabled===!1||e.enablePan===!1||Ue(t)}function he(t){if(e.enabled!==!1){switch(t.preventDefault(),t.touches.length){case 1:switch(e.touches.ONE){case s.TOUCH.ROTATE:if(e.enableRotate===!1)return;oe(t),a=i.TOUCH_ROTATE;break;case s.TOUCH.PAN:if(e.enablePan===!1)return;se(t),a=i.TOUCH_PAN;break;default:a=i.NONE}break;case 2:switch(e.touches.TWO){case s.TOUCH.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;je(t),a=i.TOUCH_DOLLY_PAN;break;case s.TOUCH.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;Se(t),a=i.TOUCH_DOLLY_ROTATE;break;default:a=i.NONE}break;default:a=i.NONE}a!==i.NONE&&e.dispatchEvent(W)}}function de(t){if(e.enabled!==!1)switch(t.preventDefault(),a){case i.TOUCH_ROTATE:if(e.enableRotate===!1)return;ie(t),e.update();break;case i.TOUCH_PAN:if(e.enablePan===!1)return;ae(t),e.update();break;case i.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;_e(t),e.update();break;case i.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;De(t),e.update();break;default:a=i.NONE}}function me(t){e.enabled!==!1&&(e.dispatchEvent(K),a=i.NONE)}function pe(t){e.enabled!==!1&&t.preventDefault()}e.domElement.addEventListener("contextmenu",pe),e.domElement.addEventListener("pointerdown",ce),e.domElement.addEventListener("wheel",ue,{passive:!1}),e.domElement.addEventListener("touchstart",he,{passive:!1}),e.domElement.addEventListener("touchend",me),e.domElement.addEventListener("touchmove",de,{passive:!1}),this.update()}}class ee{constructor(o,n){this.animation=o,this.currentEffectIndex=0,this.tickingEffects=[],this.effects=Object.entries(n).map(([e,i])=>[Number(e),Array.isArray(i)?i:[i]]).sort(([e],[i])=>e-i)}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const o=this.effects[this.currentEffectIndex];if(!(o[0]>this.animation.roundedCurrentTime))return this.currentEffectIndex++,o[1]}reset(){this.currentEffectIndex=0}}class Oe extends ee{tick(){var n;const o=(n=super.getCurrentEffects())!=null?n:[];o.length>0&&console.log(`Playing sound effects: "${o.map(e=>e.effect).join(", ")}"`)}}class Pe extends ee{constructor(){super(...arguments);this.disposables=[]}tick(){var n;this.tickingEffects.forEach(e=>e.tick());const o=(n=super.getCurrentEffects())!=null?n:[];for(const{locator:e,effect:i,pre_effect_script:a}of o){if(!i)return;const g=this.animation.getAnimator(),r=g.getModel(),l=g.getEmitter(i);if(!l||!g.winterskyScene)return;const d=e?r.getLocator(e):void 0,c=new Me.default.Emitter(g.winterskyScene,l,{parent_mode:d?"locator":"entity",loop_mode:"once"});d&&(d.add(c.local_space),c.local_space.parent=d);const w={tick:()=>{c.tick(),c.enabled||(c.delete(),this.tickingEffects=this.tickingEffects.filter(f=>f!==w))}};this.tickingEffects.push(w),this.disposables.push({dispose:()=>{c.delete(),this.tickingEffects=this.tickingEffects.filter(f=>f!==w)}}),c.start(),c.tick()}}dispose(){this.disposables.forEach(o=>o.dispose()),this.disposables=[]}}class ke{constructor(o,n){var e,i;this.animator=o,this.animationData=n,this.startTimestamp=0,this.lastFrameTimestamp=0,this.isRunning=!1,this.env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime},this.molang=new R.MoLang(this.env),this.soundEffects=new Oe(this,(e=this.animationData.sound_effects)!=null?e:{}),this.particleEffects=new Pe(this,(i=this.animationData.particle_effects)!=null?i:{})}getAnimator(){return this.animator}execute(o){return this.molang.executeAndCatch(o)}parseBoneModifier(o){if(typeof o=="number")return[o,o,o];if(typeof o=="string"){const n=typeof o=="string"?this.execute(o):o;return[n,n,n]}else{if(Array.isArray(o))return o.map(n=>typeof n=="string"?this.execute(n):n);if(o!==void 0){const n=Object.entries(o).map(([e,i])=>[Number(e),i]).sort(([e],[i])=>e-i);for(let e=n.length-1;e>=0;e--){let[i,a]=n[e];if(!(i>this.currentTime))if(i===this.currentTime){if(Array.isArray(a))return a;throw new Error("Format not supported yet")}else{let[g,r]=n[s.MathUtils.euclideanModulo(e+1,n.length)],l=g-i;if(Array.isArray(a)&&Array.isArray(r))return a.map((d,c)=>d+(r[c]-d)/l*(this.currentTime-i));throw new Error("Format not supported yet")}}return[0,0,0]}}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const o=this.animator.getModel().getBoneMap();for(let n in this.animationData.bones){const e=o.get(n);if(!e)continue;const{position:i,rotation:a,scale:g}=this.animationData.bones[n],[r,l,d]=[i,a,g].map(c=>this.parseBoneModifier(c));if(r){const c=e.position.toArray();e.position.set(...r.map((w,f)=>(f===0?-1:1)*w+c[f]))}if(l){const c=e.rotation.toArray();e.rotation.set(...l.map(s.MathUtils.degToRad).map((w,f)=>c[f]+(f===2?w:-w)))}d&&e.scale.set(...d)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class xe{constructor(o){this.model=o,this.animations=new Map,this.particleEmitters=new Map}setupDefaultBonePoses(){for(let o of this.model.getBoneMap().values())o.userData.defaultRotation=o.rotation.toArray(),o.userData.defaultPosition=o.position.toArray()}dispose(){this.disposeAnimations();for(let o of this.model.getBoneMap().values())delete o.userData.defaultRotation,delete o.userData.defaultPosition}disposeAnimations(){this.animations.forEach(o=>o.dispose())}setupWintersky(o){this.winterskyScene=o}addAnimation(o,n){this.animations.set(o,new ke(this,n))}addEmitter(o,n){this.particleEmitters.set(o,n)}getEmitter(o){return this.particleEmitters.get(o)}play(o){const n=this.animations.get(o);if(!n)throw new Error(`Unknown animation: "${o}"`);n.play()}pause(o){const n=this.animations.get(o);if(!n)throw new Error(`Unknown animation: "${o}"`);n.pause()}pauseAll(){for(const o of this.animations.values())o.pause()}tick(){for(let o of this.model.getBoneMap().values())o.rotation.set(...o.userData.defaultRotation),o.position.set(...o.userData.defaultPosition);this.animations.forEach(o=>o.shouldTick&&o.tick())}get shouldTick(){return[...this.animations.values()].some(o=>o.shouldTick)}getModel(){return this.model}}const Re=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}];class Le{constructor(o){var A,L,v;this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new s.BufferGeometry,this.group=new s.Group;const{textureSize:[n,e],textureDiscrepancyFactor:[i,a],mirror:g,width:r,height:l,depth:d}=o,c=(A=o.startUV)!=null?A:[0,0],w=!Array.isArray(c);let f=0,u=0;w||([f,u]=c);const[P,b]=[n*i,e*a];for(let{name:O,dir:j,corners:H,baseUV:[N,p]}of Re){const E=this.positions.length/3;let m,y;if(w){if(c[O]===void 0)continue;[f,u]=((L=c[O])==null?void 0:L.uv)||[],[m,y]=((v=c[O])==null?void 0:v.uv_size)||[],m*=i,y*=a,f*=i,u*=a,N=0,p=0}for(const{pos:[U,D,F],uv:V}of H)this.positions.push((g?-U:U)*r,D*l,F*d),this.normals.push(...j),this.uvs.push((f+(Number(N>0)+Number(N>2))*Math.floor(m!=null?m:d)+Number(N>1)*Math.floor(m!=null?m:r)+V[0]*Math.floor(O==="west"||O==="east"?m!=null?m:d:m!=null?m:r))/P,1-(u+p*Math.floor(y!=null?y:d)+Math.floor(O==="up"||O==="down"?y!=null?y:d:y!=null?y:l)-V[1]*Math.floor(O==="up"||O==="down"?y!=null?y:d:y!=null?y:l))/b);this.indices.push(E,E+1,E+2,E+2,E+1,E+3)}this.createGeometry(),this.createMesh(o)}createGeometry(){this.geometry.setAttribute("position",new s.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new s.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new s.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:o,width:n,height:e,depth:i,pivot:a,rotation:g,origin:r,inflate:l=0}){const d=l*2+n,c=new s.Mesh(this.geometry,o);if(this.group.rotation.order="ZYX",a===void 0&&(a=[d/2,e/2,i/2]),this.group.add(c),g){this.group.position.set(-a[0],a[1],a[2]),c.position.set(-r[0]-d/2+a[0]+l,r[1]-a[1]-l,r[2]-a[2]-l);const[w,f,u]=g;this.group.rotation.set(s.MathUtils.degToRad(-w),s.MathUtils.degToRad(-f),s.MathUtils.degToRad(u))}else this.group.position.set(-r[0]-d/2+l,r[1]-l,r[2]-l);l&&this.group.scale.set(n!==0?1+l/(n/2):1,e!==0?1+l/(e/2):1,i!==0?1+l/(i/2):1)}getGroup(){return this.group}}class ve{constructor(o){var e,i,a,g,r,l,d;if(this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new s.BufferGeometry,this.group=new s.Group,!Array.isArray(o.polys))throw new Error("Format not supported yet!");o.normalized_uvs||(o.uvs=(e=o==null?void 0:o.uvs)==null?void 0:e.map(([c,w])=>[c/o.textureSize[0],w/o.textureSize[1]]));let n=0;for(const c of o.polys){for(const[w,f,u]of c)this.positions.push(...(a=(i=o==null?void 0:o.positions)==null?void 0:i[w])!=null?a:[]),this.normals.push(...(r=(g=o==null?void 0:o.normals)==null?void 0:g[f])!=null?r:[]),this.uvs.push(...(d=(l=o==null?void 0:o.uvs)==null?void 0:l[u])!=null?d:[]);c.length===3?this.indices.push(n,n+1,n+2):this.indices.push(n+2,n+1,n,n+2,n,n+3),n+=c.length}this.createGeometry(),this.createMesh(o)}createGeometry(){this.geometry.setAttribute("position",new s.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new s.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new s.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:o}){const n=new s.Mesh(this.geometry,o);this.group.add(n)}getGroup(){return this.group}}class te{constructor(o,n){var i,a;this.modelData=o,this.texturePath=n,this.boneMap=new Map,this.locators=new Map,this.animator=new xe(this);const e=(a=(i=o==null?void 0:o.description)==null?void 0:i.identifier)!=null?a:"geometry.unknown";this.model=new s.Group,this.model.name=e}async create(){var r,l,d,c,w,f;const o=this.modelData,n=await this.loadTexture(this.texturePath),e=[(l=(r=o==null?void 0:o.description)==null?void 0:r.texture_width)!=null?l:n.image.width,(c=(d=o==null?void 0:o.description)==null?void 0:d.texture_height)!=null?c:n.image.height],i=[n.image.width/e[0],n.image.height/e[1]],a=new Map;n.magFilter=s.NearestFilter,n.minFilter=s.NearestFilter;const g=new s.MeshLambertMaterial({side:s.DoubleSide,alphaTest:.2,transparent:!0,map:n});(w=o==null?void 0:o.bones)==null||w.forEach(u=>{var L,v,O,j,H,N;const P=new s.Group;if(P.name=(L=u.name)!=null?L:"unknown",u.poly_mesh){const p=new ve(Ee(be({},u.poly_mesh),{textureSize:e,material:g,mirror:(v=u.mirror)!=null?v:!1,origin:[0,0,0],inflate:u.inflate,rotation:[0,0,0],pivot:u.pivot})).getGroup();p.name=`#bone.${u.name}#polyMesh`,P.add(p)}(O=u.cubes)==null||O.forEach((p,E)=>{var y,U,D,F,V,B,Y,Z,q,z,X;const m=new Le({width:(U=(y=p.size)==null?void 0:y[0])!=null?U:0,height:(F=(D=p.size)==null?void 0:D[1])!=null?F:0,depth:(B=(V=p.size)==null?void 0:V[2])!=null?B:0,startUV:p.uv,textureSize:e,textureDiscrepancyFactor:i,material:g,mirror:p.mirror===void 0&&p.rotation===void 0?(Y=u.mirror)!=null?Y:!1:(Z=p.mirror)!=null?Z:!1,origin:(q=p.origin)!=null?q:[0,0,0],inflate:(z=p.inflate)!=null?z:u.inflate,rotation:p.rotation,pivot:(X=p.pivot)!=null?X:u.pivot}).getGroup();m.name=`#bone.${u.name}#cube.${E}`,P.add(m)});const b=new s.Group;if(b.rotation.order="ZYX",u.pivot){const[p,E,m]=u.pivot;b.position.set(-p,E,m),P.position.set(p,-E,-m)}else b.position.set(0,0,0);if(b.add(P),b.name=`#pivot.${u.name}`,u.rotation){const[p,E,m]=u.rotation;b.rotation.set(s.MathUtils.degToRad(-p),s.MathUtils.degToRad(-E),s.MathUtils.degToRad(m))}const A=(j=u.locators)!=null?j:{};for(const p in A){const E=new s.Group;E.name=`locator#${p}`;const m=A[p];Array.isArray(m)?E.position.set(...m):typeof m=="object"&&(E.position.set(...(H=m.offset)!=null?H:[0,0,0]),E.rotation.set(...(N=m.rotation)!=null?N:[0,0,0])),this.locators.set(p,E),b.add(E)}u.parent||this.model.add(b),u.name&&(a.set(u.name,[u.parent,b]),this.boneMap.set(u.name,b))});for(let[u,[P,b]]of a)if(P){const A=(f=a.get(P))==null?void 0:f[1];A&&A.name.startsWith("#pivot.")?A.children[0].add(b):A&&A.add(b)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(o){return this.locators.get(o)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(o,n,e){const i=new s.LineBasicMaterial({side:s.DoubleSide,color:o,linewidth:20}),a=new s.BoxGeometry(e.x,e.y,e.z),g=new s.EdgesGeometry(a),r=new s.LineSegments(g,i);return r.position.set(n.x,n.y+e.y/2,n.z),r.name="helperBox",this.model.add(r),{dispose:()=>{this.model.remove(r)}}}dispose(){this.animator.dispose()}loadTexture(o){return new Promise((n,e)=>{new s.TextureLoader().load(o,a=>{n(a)})})}}class Ne{constructor(o,n,e,i){var a;this.canvasElement=o,this.texturePath=e,this.options=i,this.renderingRequested=!1,this.renderer=new s.WebGLRenderer({canvas:o,antialias:(a=i.antialias)!=null?a:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new s.PerspectiveCamera(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new Ae(this.camera,o),this.scene=new s.Scene,this.scene.add(new s.AmbientLight(16777215)),this.scene.background=new s.Color(13299960),this.model=new te(n,e),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",()=>this.requestRendering()),this.onResize(),this.loadedModel=this.loadModel().then(()=>this.requestRendering())}async loadModel(){await this.model.create()}get width(){var o;return(o=this.options.width)!=null?o:window.innerWidth}get height(){var o;return(o=this.options.height)!=null?o:window.innerHeight}render(o=!0){var n;this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,o&&this.model.shouldTick&&(this.model.tick(),(n=this.model.animator.winterskyScene)==null||n.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(o=!1){if(o)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame(()=>this.render()))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new s.AxesHelper(50)),this.scene.add(new s.GridHelper(20,20)),this.scene.add(new s.BoxHelper(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(o=1.5,n=!0){n&&this.model.getGroup().rotation.set(0,Math.PI,0);const e=new s.Box3().setFromObject(this.model.getGroup()).getBoundingSphere(new s.Sphere),i=this.camera.fov*Math.PI/180*o,a=e.radius/Math.tan(i/2),g=Math.sqrt(Math.pow(a,2)+Math.pow(a,2));this.camera.position.set(g,g,g),this.controls.update(),this.camera.lookAt(e.center),this.controls.target.set(e.center.x,e.center.y,e.center.z),this.camera.updateProjectionMatrix()}}M.Model=te,M.StandaloneModelViewer=Ne,Object.defineProperty(M,"__esModule",{value:!0}),M[Symbol.toStringTag]="Module"});
