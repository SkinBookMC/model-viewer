var ze=Object.defineProperty,Ce=Object.defineProperties;var Xe=Object.getOwnPropertyDescriptors;var we=Object.getOwnPropertySymbols;var We=Object.prototype.hasOwnProperty,Ke=Object.prototype.propertyIsEnumerable;var ye=(M,n,v)=>n in M?ze(M,n,{enumerable:!0,configurable:!0,writable:!0,value:v}):M[n]=v,Ee=(M,n)=>{for(var v in n||(n={}))We.call(n,v)&&ye(M,v,n[v]);if(we)for(var v of we(n))Ke.call(n,v)&&ye(M,v,n[v]);return M},Te=(M,n)=>Ce(M,Xe(n));(function(M,n){typeof exports=="object"&&typeof module!="undefined"?n(exports,require("three"),require("molang"),require("wintersky")):typeof define=="function"&&define.amd?define(["exports","three","molang","wintersky"],n):(M=typeof globalThis!="undefined"?globalThis:M||self,n(M.ModelViewer={},M.three,M.molang,M.Wintersky))})(this,function(M,n,v,Me){"use strict";function Ae(R){return R&&typeof R=="object"&&"default"in R?R:{default:R}}var Pe=Ae(Me);const ee={type:"change"},K={type:"start"},te={type:"end"};class xe extends n.EventDispatcher{constructor(o,i){super();i===void 0&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=o,this.domElement=i,this.domElement.style.touchAction="none",this.enabled=!0,this.target=new n.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:n.MOUSE.ROTATE,MIDDLE:n.MOUSE.DOLLY,RIGHT:n.MOUSE.PAN},this.touches={ONE:n.TOUCH.ROTATE,TWO:n.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return r.phi},this.getAzimuthalAngle=function(){return r.theta},this.getDistance=function(){return this.object.position.distanceTo(this.target)},this.listenToKeyEvents=function(t){t.addEventListener("keydown",pe),this._domElementKeyEvents=t},this.saveState=function(){e.target0.copy(e.target),e.position0.copy(e.object.position),e.zoom0=e.object.zoom},this.reset=function(){e.target.copy(e.target0),e.object.position.copy(e.position0),e.object.zoom=e.zoom0,e.object.updateProjectionMatrix(),e.dispatchEvent(ee),e.update(),a=s.NONE},this.update=function(){const t=new n.Vector3,c=new n.Quaternion().setFromUnitVectors(o.up,new n.Vector3(0,1,0)),O=c.clone().invert(),k=new n.Vector3,_=new n.Quaternion,G=2*Math.PI;return function(){const be=e.object.position;t.copy(be).sub(e.target),t.applyQuaternion(c),r.setFromVector3(t),e.autoRotate&&a===s.NONE&&m(b()),e.enableDamping?(r.theta+=u.theta*e.dampingFactor,r.phi+=u.phi*e.dampingFactor):(r.theta+=u.theta,r.phi+=u.phi);let V=e.minAzimuthAngle,D=e.maxAzimuthAngle;return isFinite(V)&&isFinite(D)&&(V<-Math.PI?V+=G:V>Math.PI&&(V-=G),D<-Math.PI?D+=G:D>Math.PI&&(D-=G),V<=D?r.theta=Math.max(V,Math.min(D,r.theta)):r.theta=r.theta>(V+D)/2?Math.max(V,r.theta):Math.min(D,r.theta)),r.phi=Math.max(e.minPolarAngle,Math.min(e.maxPolarAngle,r.phi)),r.makeSafe(),r.radius*=p,r.radius=Math.max(e.minDistance,Math.min(e.maxDistance,r.radius)),e.enableDamping===!0?e.target.addScaledVector(d,e.dampingFactor):e.target.add(d),t.setFromSpherical(r),t.applyQuaternion(O),be.copy(e.target).add(t),e.object.lookAt(e.target),e.enableDamping===!0?(u.theta*=1-e.dampingFactor,u.phi*=1-e.dampingFactor,d.multiplyScalar(1-e.dampingFactor)):(u.set(0,0,0),d.set(0,0,0)),p=1,E||k.distanceToSquared(e.object.position)>g||8*(1-_.dot(e.object.quaternion))>g?(e.dispatchEvent(ee),k.copy(e.object.position),_.copy(e.object.quaternion),E=!1,!0):!1}}(),this.dispose=function(){e.domElement.removeEventListener("contextmenu",me),e.domElement.removeEventListener("pointerdown",ue),e.domElement.removeEventListener("pointercancel",de),e.domElement.removeEventListener("wheel",he),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Q),e._domElementKeyEvents!==null&&e._domElementKeyEvents.removeEventListener("keydown",pe)};const e=this,s={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let a=s.NONE;const g=1e-6,r=new n.Spherical,u=new n.Spherical;let p=1;const d=new n.Vector3;let E=!1;const f=new n.Vector2,l=new n.Vector2,A=new n.Vector2,w=new n.Vector2,P=new n.Vector2,L=new n.Vector2,N=new n.Vector2,x=new n.Vector2,I=new n.Vector2,h=[],j={};function b(){return 2*Math.PI/60/60*e.autoRotateSpeed}function y(){return Math.pow(.95,e.zoomSpeed)}function m(t){u.theta-=t}function T(t){u.phi-=t}const F=function(){const t=new n.Vector3;return function(O,k){t.setFromMatrixColumn(k,0),t.multiplyScalar(-O),d.add(t)}}(),H=function(){const t=new n.Vector3;return function(O,k){e.screenSpacePanning===!0?t.setFromMatrixColumn(k,1):(t.setFromMatrixColumn(k,0),t.crossVectors(e.object.up,t)),t.multiplyScalar(O),d.add(t)}}(),U=function(){const t=new n.Vector3;return function(O,k){const _=e.domElement;if(e.object.isPerspectiveCamera){const G=e.object.position;t.copy(G).sub(e.target);let W=t.length();W*=Math.tan(e.object.fov/2*Math.PI/180),F(2*O*W/_.clientHeight,e.object.matrix),H(2*k*W/_.clientHeight,e.object.matrix)}else e.object.isOrthographicCamera?(F(O*(e.object.right-e.object.left)/e.object.zoom/_.clientWidth,e.object.matrix),H(k*(e.object.top-e.object.bottom)/e.object.zoom/_.clientHeight,e.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),e.enablePan=!1)}}();function S(t){e.object.isPerspectiveCamera?p/=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom*t)),e.object.updateProjectionMatrix(),E=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function Y(t){e.object.isPerspectiveCamera?p*=t:e.object.isOrthographicCamera?(e.object.zoom=Math.max(e.minZoom,Math.min(e.maxZoom,e.object.zoom/t)),e.object.updateProjectionMatrix(),E=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),e.enableZoom=!1)}function B(t){f.set(t.clientX,t.clientY)}function z(t){N.set(t.clientX,t.clientY)}function Z(t){w.set(t.clientX,t.clientY)}function C(t){l.set(t.clientX,t.clientY),A.subVectors(l,f).multiplyScalar(e.rotateSpeed);const c=e.domElement;m(2*Math.PI*A.x/c.clientHeight),T(2*Math.PI*A.y/c.clientHeight),f.copy(l),e.update()}function X(t){x.set(t.clientX,t.clientY),I.subVectors(x,N),I.y>0?S(y()):I.y<0&&Y(y()),N.copy(x),e.update()}function Se(t){P.set(t.clientX,t.clientY),L.subVectors(P,w).multiplyScalar(e.panSpeed),U(L.x,L.y),w.copy(P),e.update()}function _e(t){t.deltaY<0?Y(y()):t.deltaY>0&&S(y()),e.update()}function Ie(t){let c=!1;switch(t.code){case e.keys.UP:U(0,e.keyPanSpeed),c=!0;break;case e.keys.BOTTOM:U(0,-e.keyPanSpeed),c=!0;break;case e.keys.LEFT:U(e.keyPanSpeed,0),c=!0;break;case e.keys.RIGHT:U(-e.keyPanSpeed,0),c=!0;break}c&&(t.preventDefault(),e.update())}function ie(){if(h.length===1)f.set(h[0].pageX,h[0].pageY);else{const t=.5*(h[0].pageX+h[1].pageX),c=.5*(h[0].pageY+h[1].pageY);f.set(t,c)}}function se(){if(h.length===1)w.set(h[0].pageX,h[0].pageY);else{const t=.5*(h[0].pageX+h[1].pageX),c=.5*(h[0].pageY+h[1].pageY);w.set(t,c)}}function ae(){const t=h[0].pageX-h[1].pageX,c=h[0].pageY-h[1].pageY,O=Math.sqrt(t*t+c*c);N.set(0,O)}function Ve(){e.enableZoom&&ae(),e.enablePan&&se()}function De(){e.enableZoom&&ae(),e.enableRotate&&ie()}function re(t){if(h.length==1)l.set(t.pageX,t.pageY);else{const O=J(t),k=.5*(t.pageX+O.x),_=.5*(t.pageY+O.y);l.set(k,_)}A.subVectors(l,f).multiplyScalar(e.rotateSpeed);const c=e.domElement;m(2*Math.PI*A.x/c.clientHeight),T(2*Math.PI*A.y/c.clientHeight),f.copy(l)}function ce(t){if(h.length===1)P.set(t.pageX,t.pageY);else{const c=J(t),O=.5*(t.pageX+c.x),k=.5*(t.pageY+c.y);P.set(O,k)}L.subVectors(P,w).multiplyScalar(e.panSpeed),U(L.x,L.y),w.copy(P)}function le(t){const c=J(t),O=t.pageX-c.x,k=t.pageY-c.y,_=Math.sqrt(O*O+k*k);x.set(0,_),I.set(0,Math.pow(x.y/N.y,e.zoomSpeed)),S(I.y),N.copy(x)}function Fe(t){e.enableZoom&&le(t),e.enablePan&&ce(t)}function He(t){e.enableZoom&&le(t),e.enableRotate&&re(t)}function ue(t){e.enabled!==!1&&(h.length===0&&(e.domElement.setPointerCapture(t.pointerId),e.domElement.addEventListener("pointermove",$),e.domElement.addEventListener("pointerup",Q)),qe(t),t.pointerType==="touch"?Be(t):Ge(t))}function $(t){e.enabled!==!1&&(t.pointerType==="touch"?Ze(t):Ye(t))}function Q(t){fe(t),h.length===0&&(e.domElement.releasePointerCapture(t.pointerId),e.domElement.removeEventListener("pointermove",$),e.domElement.removeEventListener("pointerup",Q)),e.dispatchEvent(te),a=s.NONE}function de(t){fe(t)}function Ge(t){let c;switch(t.button){case 0:c=e.mouseButtons.LEFT;break;case 1:c=e.mouseButtons.MIDDLE;break;case 2:c=e.mouseButtons.RIGHT;break;default:c=-1}switch(c){case n.MOUSE.DOLLY:if(e.enableZoom===!1)return;z(t),a=s.DOLLY;break;case n.MOUSE.ROTATE:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enablePan===!1)return;Z(t),a=s.PAN}else{if(e.enableRotate===!1)return;B(t),a=s.ROTATE}break;case n.MOUSE.PAN:if(t.ctrlKey||t.metaKey||t.shiftKey){if(e.enableRotate===!1)return;B(t),a=s.ROTATE}else{if(e.enablePan===!1)return;Z(t),a=s.PAN}break;default:a=s.NONE}a!==s.NONE&&e.dispatchEvent(K)}function Ye(t){if(e.enabled!==!1)switch(a){case s.ROTATE:if(e.enableRotate===!1)return;C(t);break;case s.DOLLY:if(e.enableZoom===!1)return;X(t);break;case s.PAN:if(e.enablePan===!1)return;Se(t);break}}function he(t){e.enabled===!1||e.enableZoom===!1||a!==s.NONE||(t.preventDefault(),e.dispatchEvent(K),_e(t),e.dispatchEvent(te))}function pe(t){e.enabled===!1||e.enablePan===!1||Ie(t)}function Be(t){switch(ge(t),h.length){case 1:switch(e.touches.ONE){case n.TOUCH.ROTATE:if(e.enableRotate===!1)return;ie(),a=s.TOUCH_ROTATE;break;case n.TOUCH.PAN:if(e.enablePan===!1)return;se(),a=s.TOUCH_PAN;break;default:a=s.NONE}break;case 2:switch(e.touches.TWO){case n.TOUCH.DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Ve(),a=s.TOUCH_DOLLY_PAN;break;case n.TOUCH.DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;De(),a=s.TOUCH_DOLLY_ROTATE;break;default:a=s.NONE}break;default:a=s.NONE}a!==s.NONE&&e.dispatchEvent(K)}function Ze(t){switch(ge(t),a){case s.TOUCH_ROTATE:if(e.enableRotate===!1)return;re(t),e.update();break;case s.TOUCH_PAN:if(e.enablePan===!1)return;ce(t),e.update();break;case s.TOUCH_DOLLY_PAN:if(e.enableZoom===!1&&e.enablePan===!1)return;Fe(t),e.update();break;case s.TOUCH_DOLLY_ROTATE:if(e.enableZoom===!1&&e.enableRotate===!1)return;He(t),e.update();break;default:a=s.NONE}}function me(t){e.enabled!==!1&&t.preventDefault()}function qe(t){h.push(t)}function fe(t){delete j[t.pointerId];for(let c=0;c<h.length;c++)if(h[c].pointerId==t.pointerId){h.splice(c,1);return}}function ge(t){let c=j[t.pointerId];c===void 0&&(c=new n.Vector2,j[t.pointerId]=c),c.set(t.pageX,t.pageY)}function J(t){const c=t.pointerId===h[0].pointerId?h[1]:h[0];return j[c.pointerId]}e.domElement.addEventListener("contextmenu",me),e.domElement.addEventListener("pointerdown",ue),e.domElement.addEventListener("pointercancel",de),e.domElement.addEventListener("wheel",he,{passive:!1}),this.update()}}class oe{constructor(o,i){this.animation=o,this.currentEffectIndex=0,this.tickingEffects=[],this.effects=Object.entries(i).map(([e,s])=>[Number(e),Array.isArray(s)?s:[s]]).sort(([e],[s])=>e-s)}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const o=this.effects[this.currentEffectIndex];if(!(o[0]>this.animation.roundedCurrentTime))return this.currentEffectIndex++,o[1]}reset(){this.currentEffectIndex=0}}class Oe extends oe{tick(){var i;const o=(i=super.getCurrentEffects())!=null?i:[];o.length>0&&console.log(`Playing sound effects: "${o.map(e=>e.effect).join(", ")}"`)}}class ke extends oe{constructor(){super(...arguments);this.disposables=[]}tick(){var i;this.tickingEffects.forEach(e=>e.tick());const o=(i=super.getCurrentEffects())!=null?i:[];for(const{locator:e,effect:s,pre_effect_script:a}of o){if(!s)return;const g=this.animation.getAnimator(),r=g.getModel(),u=g.getEmitter(s);if(!u||!g.winterskyScene)return;const p=e?r.getLocator(e):void 0,d=new Pe.default.Emitter(g.winterskyScene,u,{parent_mode:p?"locator":"entity",loop_mode:"once"});p&&(p.add(d.local_space),d.local_space.parent=p);const E={tick:()=>{d.tick(),d.enabled||(d.delete(),this.tickingEffects=this.tickingEffects.filter(f=>f!==E))}};this.tickingEffects.push(E),this.disposables.push({dispose:()=>{d.delete(),this.tickingEffects=this.tickingEffects.filter(f=>f!==E)}}),d.start(),d.tick()}}dispose(){this.disposables.forEach(o=>o.dispose()),this.disposables=[]}}class Re{constructor(o,i){var e,s;this.animator=o,this.animationData=i,this.startTimestamp=0,this.lastFrameTimestamp=0,this.isRunning=!1,this.env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime},this.molang=new v.MoLang(this.env),this.soundEffects=new Oe(this,(e=this.animationData.sound_effects)!=null?e:{}),this.particleEffects=new ke(this,(s=this.animationData.particle_effects)!=null?s:{})}getAnimator(){return this.animator}execute(o){return this.molang.executeAndCatch(o)}parseBoneModifier(o){if(typeof o=="number")return[o,o,o];if(typeof o=="string"){const i=typeof o=="string"?this.execute(o):o;return[i,i,i]}else{if(Array.isArray(o))return o.map(i=>typeof i=="string"?this.execute(i):i);if(o!==void 0){const i=Object.entries(o).map(([e,s])=>[Number(e),s]).sort(([e],[s])=>e-s);for(let e=i.length-1;e>=0;e--){let[s,a]=i[e];if(!(s>this.currentTime))if(s===this.currentTime){if(Array.isArray(a))return a;throw new Error("Format not supported yet")}else{let[g,r]=i[n.MathUtils.euclideanModulo(e+1,i.length)],u=g-s;if(Array.isArray(a)&&Array.isArray(r))return a.map((p,d)=>p+(r[d]-p)/u*(this.currentTime-s));throw new Error("Format not supported yet")}}return[0,0,0]}}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const o=this.animator.getModel().getBoneMap();for(let i in this.animationData.bones){const e=o.get(i);if(!e)continue;const{position:s,rotation:a,scale:g}=this.animationData.bones[i],[r,u,p]=[s,a,g].map(d=>this.parseBoneModifier(d));if(r){const d=e.position.toArray();e.position.set(...r.map((E,f)=>(f===0?-1:1)*E+d[f]))}if(u){const d=e.rotation.toArray();e.rotation.set(...u.map(n.MathUtils.degToRad).map((E,f)=>d[f]+(f===2?E:-E)))}p&&e.scale.set(...p)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class ve{constructor(o){this.model=o,this.animations=new Map,this.particleEmitters=new Map}setupDefaultBonePoses(){for(let o of this.model.getBoneMap().values())o.userData.defaultRotation=o.rotation.toArray(),o.userData.defaultPosition=o.position.toArray()}dispose(){this.disposeAnimations();for(let o of this.model.getBoneMap().values())delete o.userData.defaultRotation,delete o.userData.defaultPosition}disposeAnimations(){this.animations.forEach(o=>o.dispose())}setupWintersky(o){this.winterskyScene=o}addAnimation(o,i){this.animations.set(o,new Re(this,i))}addEmitter(o,i){this.particleEmitters.set(o,i)}getEmitter(o){return this.particleEmitters.get(o)}play(o){const i=this.animations.get(o);if(!i)throw new Error(`Unknown animation: "${o}"`);i.play()}pause(o){const i=this.animations.get(o);if(!i)throw new Error(`Unknown animation: "${o}"`);i.pause()}pauseAll(){for(const o of this.animations.values())o.pause()}tick(){for(let o of this.model.getBoneMap().values())o.rotation.set(...o.userData.defaultRotation),o.position.set(...o.userData.defaultPosition);this.animations.forEach(o=>o.shouldTick&&o.tick())}get shouldTick(){return[...this.animations.values()].some(o=>o.shouldTick)}getModel(){return this.model}}const Le=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}],q=.03;class Ne{constructor(o){var P,L,N;this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new n.BufferGeometry,this.group=new n.Group;const{textureSize:[i,e],textureDiscrepancyFactor:[s,a],mirror:g,width:r,height:u,depth:p}=o,[d,E]=[i*s,e*a],f=(P=o.startUV)!=null?P:[0,0],l=!Array.isArray(f);let A=0,w=0;l||([A,w]=f);for(let{name:x,dir:I,corners:h,baseUV:[j,b]}of Le){const y=this.positions.length/3;let m,T;if(l){if(f[x]===void 0)continue;[A,w]=((L=f[x])==null?void 0:L.uv)||[],[m,T]=((N=f[x])==null?void 0:N.uv_size)||[],m*=s,T*=a,A*=s,w*=a,j=0,b=0}for(const{pos:[F,H,U],uv:S}of h)this.positions.push((g?-F:F)*r,H*u,U*p),this.normals.push(...I),this.uvs.push((A+(Number(j>0)+Number(j>2))*Math.floor(m!=null?m:p)+Number(j>1)*Math.floor(m!=null?m:r)+S[0]*Math.floor(x==="west"||x==="east"?m!=null?m:p:m!=null?m:r)+(S[0]===0?q:-q))/(d/(l?1:s)),1-(w+b*Math.floor(T!=null?T:p)+Math.floor(x==="up"||x==="down"?T!=null?T:p:T!=null?T:u)-S[1]*Math.floor(x==="up"||x==="down"?T!=null?T:p:T!=null?T:u)+(S[1]===0?-q:q))/(E/(l?1:a)));this.indices.push(y,y+1,y+2,y+2,y+1,y+3)}this.createGeometry(),this.createMesh(o)}createGeometry(){this.geometry.setAttribute("position",new n.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new n.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new n.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:o,width:i,height:e,depth:s,pivot:a,rotation:g,origin:r,inflate:u=0}){const p=u*2+i,d=new n.Mesh(this.geometry,o);if(this.group.rotation.order="ZYX",a===void 0&&(a=[p/2,e/2,s/2]),this.group.add(d),g){this.group.position.set(-a[0],a[1],a[2]),d.position.set(-r[0]-p/2+a[0]+u,r[1]-a[1]-u,r[2]-a[2]-u);const[E,f,l]=g;this.group.rotation.set(n.MathUtils.degToRad(-E),n.MathUtils.degToRad(-f),n.MathUtils.degToRad(l))}else this.group.position.set(-r[0]-p/2+u,r[1]-u,r[2]-u);u&&this.group.scale.set(i!==0?1+u/(i/2):1,e!==0?1+u/(e/2):1,s!==0?1+u/(s/2):1)}getGroup(){return this.group}}class je{constructor(o){var e,s,a,g,r,u,p;if(this.positions=[],this.indices=[],this.normals=[],this.uvs=[],this.geometry=new n.BufferGeometry,this.group=new n.Group,!Array.isArray(o.polys))throw new Error("Format not supported yet!");o.normalized_uvs||(o.uvs=(e=o==null?void 0:o.uvs)==null?void 0:e.map(([d,E])=>[d/o.textureSize[0],E/o.textureSize[1]]));let i=0;for(const d of o.polys){for(const[E,f,l]of d)this.positions.push(...(a=(s=o==null?void 0:o.positions)==null?void 0:s[E])!=null?a:[]),this.normals.push(...(r=(g=o==null?void 0:o.normals)==null?void 0:g[f])!=null?r:[]),this.uvs.push(...(p=(u=o==null?void 0:o.uvs)==null?void 0:u[l])!=null?p:[]);d.length===3?this.indices.push(i,i+1,i+2):this.indices.push(i+2,i+1,i,i+2,i,i+3),i+=d.length}this.createGeometry(),this.createMesh(o)}createGeometry(){this.geometry.setAttribute("position",new n.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new n.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new n.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:o}){const i=new n.Mesh(this.geometry,o);this.group.add(i)}getGroup(){return this.group}}class ne{constructor(o,i){var s,a;this.modelData=o,this.texturePath=i,this.boneMap=new Map,this.locators=new Map,this.animator=new ve(this);const e=(a=(s=o==null?void 0:o.description)==null?void 0:s.identifier)!=null?a:"geometry.unknown";this.model=new n.Group,this.model.name=e}async create(){var r,u,p,d,E,f;const o=this.modelData,i=await this.loadTexture(this.texturePath),e=[(u=(r=o==null?void 0:o.description)==null?void 0:r.texture_width)!=null?u:i.image.width,(d=(p=o==null?void 0:o.description)==null?void 0:p.texture_height)!=null?d:i.image.height],s=[i.image.width/e[0],i.image.height/e[1]],a=new Map;i.magFilter=n.NearestFilter,i.minFilter=n.NearestFilter;const g=new n.MeshLambertMaterial({side:n.DoubleSide,alphaTest:.2,transparent:!0,map:i});(E=o==null?void 0:o.bones)==null||E.forEach(l=>{var L,N,x,I,h,j;const A=new n.Group;if(A.name=(L=l.name)!=null?L:"unknown",l.poly_mesh){const b=new je(Te(Ee({},l.poly_mesh),{textureSize:e,material:g,mirror:(N=l.mirror)!=null?N:!1,origin:[0,0,0],inflate:l.inflate,rotation:[0,0,0],pivot:l.pivot})).getGroup();b.name=`#bone.${l.name}#polyMesh`,A.add(b)}(x=l.cubes)==null||x.forEach((b,y)=>{var T,F,H,U,S,Y,B,z,Z,C,X;const m=new Ne({width:(F=(T=b.size)==null?void 0:T[0])!=null?F:0,height:(U=(H=b.size)==null?void 0:H[1])!=null?U:0,depth:(Y=(S=b.size)==null?void 0:S[2])!=null?Y:0,startUV:b.uv,textureSize:e,textureDiscrepancyFactor:s,material:g,mirror:b.mirror===void 0&&b.rotation===void 0?(B=l.mirror)!=null?B:!1:(z=b.mirror)!=null?z:!1,origin:(Z=b.origin)!=null?Z:[0,0,0],inflate:(C=b.inflate)!=null?C:l.inflate,rotation:b.rotation,pivot:(X=b.pivot)!=null?X:l.pivot}).getGroup();m.name=`#bone.${l.name}#cube.${y}`,A.add(m)});const w=new n.Group;if(w.rotation.order="ZYX",l.pivot){const[b,y,m]=l.pivot;w.position.set(-b,y,m),A.position.set(b,-y,-m)}else w.position.set(0,0,0);if(w.add(A),w.name=`#pivot.${l.name}`,l.rotation){const[b,y,m]=l.rotation;w.rotation.set(n.MathUtils.degToRad(-b),n.MathUtils.degToRad(-y),n.MathUtils.degToRad(m))}const P=(I=l.locators)!=null?I:{};for(const b in P){const y=new n.Group;y.name=`locator#${b}`;const m=P[b];Array.isArray(m)?y.position.set(...m):typeof m=="object"&&(y.position.set(...(h=m.offset)!=null?h:[0,0,0]),y.rotation.set(...(j=m.rotation)!=null?j:[0,0,0])),this.locators.set(b,y),w.add(y)}l.parent||this.model.add(w),l.name&&(a.set(l.name,[l.parent,w]),this.boneMap.set(l.name,w))});for(let[l,[A,w]]of a)if(A){const P=(f=a.get(A))==null?void 0:f[1];P&&P.name.startsWith("#pivot.")?P.children[0].add(w):P&&P.add(w)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(o){return this.locators.get(o)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(o,i,e){const s=new n.LineBasicMaterial({side:n.DoubleSide,color:o,linewidth:20}),a=new n.BoxGeometry(e.x,e.y,e.z),g=new n.EdgesGeometry(a),r=new n.LineSegments(g,s);return r.position.set(i.x,i.y+e.y/2,i.z),r.name="helperBox",this.model.add(r),{dispose:()=>{this.model.remove(r)}}}hideBone(o){const i=this.boneMap.get(o);i&&(i.visible=!1)}showBone(o){const i=this.boneMap.get(o);i&&(i.visible=!0)}get bones(){return[...this.boneMap.keys()]}dispose(){this.animator.dispose()}loadTexture(o){return new Promise((i,e)=>{new n.TextureLoader().load(o,a=>{i(a)})})}}class Ue{constructor(o,i,e,s){var a;this.canvasElement=o,this.texturePath=e,this.options=s,this.renderingRequested=!1,this.renderer=new n.WebGLRenderer({canvas:o,antialias:(a=s.antialias)!=null?a:!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new n.PerspectiveCamera(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new xe(this.camera,o),this.scene=new n.Scene,this.scene.add(new n.AmbientLight(16777215)),this.scene.background=new n.Color(13299960),this.model=new ne(i,e),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",()=>this.requestRendering()),this.onResize(),this.loadedModel=this.loadModel().then(()=>this.requestRendering())}async loadModel(){await this.model.create()}get width(){var o;return(o=this.options.width)!=null?o:window.innerWidth}get height(){var o;return(o=this.options.height)!=null?o:window.innerHeight}render(o=!0){var i;this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,o&&this.model.shouldTick&&(this.model.tick(),(i=this.model.animator.winterskyScene)==null||i.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(o=!1){if(o)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame(()=>this.render()))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new n.AxesHelper(50)),this.scene.add(new n.GridHelper(20,20)),this.scene.add(new n.BoxHelper(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(o=1.5,i=!0){i&&this.model.getGroup().rotation.set(0,Math.PI,0);const e=new n.Box3().setFromObject(this.model.getGroup()).getBoundingSphere(new n.Sphere),s=this.camera.fov*Math.PI/180*o,a=e.radius/Math.tan(s/2),g=Math.sqrt(Math.pow(a,2)+Math.pow(a,2));this.camera.position.set(g,g,g),this.controls.update(),this.camera.lookAt(e.center),this.controls.target.set(e.center.x,e.center.y,e.center.z),this.camera.updateProjectionMatrix()}}M.Model=ne,M.StandaloneModelViewer=Ue,Object.defineProperty(M,"__esModule",{value:!0}),M[Symbol.toStringTag]="Module"});
