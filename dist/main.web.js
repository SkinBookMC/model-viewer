var BridgeModelViewer=function(e,t,o,n){"use strict";function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=i(n);const a={type:"change"},r={type:"start"},c={type:"end"};class h extends t.EventDispatcher{constructor(e,o){super(),void 0===o&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),o===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=e,this.domElement=o,this.enabled=!0,this.target=new t.Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:t.MOUSE.ROTATE,MIDDLE:t.MOUSE.DOLLY,RIGHT:t.MOUSE.PAN},this.touches={ONE:t.TOUCH.ROTATE,TWO:t.TOUCH.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return u.phi},this.getAzimuthalAngle=function(){return u.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",B),this._domElementKeyEvents=e},this.saveState=function(){n.target0.copy(n.target),n.position0.copy(n.object.position),n.zoom0=n.object.zoom},this.reset=function(){n.target.copy(n.target0),n.object.position.copy(n.position0),n.object.zoom=n.zoom0,n.object.updateProjectionMatrix(),n.dispatchEvent(a),n.update(),s=i.NONE},this.update=function(){const o=new t.Vector3,r=(new t.Quaternion).setFromUnitVectors(e.up,new t.Vector3(0,1,0)),c=r.clone().invert(),f=new t.Vector3,g=new t.Quaternion,b=2*Math.PI;return function(){const e=n.object.position;o.copy(e).sub(n.target),o.applyQuaternion(r),u.setFromVector3(o),n.autoRotate&&s===i.NONE&&O(2*Math.PI/60/60*n.autoRotateSpeed),n.enableDamping?(u.theta+=l.theta*n.dampingFactor,u.phi+=l.phi*n.dampingFactor):(u.theta+=l.theta,u.phi+=l.phi);let t=n.minAzimuthAngle,w=n.maxAzimuthAngle;return isFinite(t)&&isFinite(w)&&(t<-Math.PI?t+=b:t>Math.PI&&(t-=b),w<-Math.PI?w+=b:w>Math.PI&&(w-=b),u.theta=t<=w?Math.max(t,Math.min(w,u.theta)):u.theta>(t+w)/2?Math.max(t,u.theta):Math.min(w,u.theta)),u.phi=Math.max(n.minPolarAngle,Math.min(n.maxPolarAngle,u.phi)),u.makeSafe(),u.radius*=m,u.radius=Math.max(n.minDistance,Math.min(n.maxDistance,u.radius)),!0===n.enableDamping?n.target.addScaledVector(d,n.dampingFactor):n.target.add(d),o.setFromSpherical(u),o.applyQuaternion(c),e.copy(n.target).add(o),n.object.lookAt(n.target),!0===n.enableDamping?(l.theta*=1-n.dampingFactor,l.phi*=1-n.dampingFactor,d.multiplyScalar(1-n.dampingFactor)):(l.set(0,0,0),d.set(0,0,0)),m=1,!!(p||f.distanceToSquared(n.object.position)>h||8*(1-g.dot(n.object.quaternion))>h)&&(n.dispatchEvent(a),f.copy(n.object.position),g.copy(n.object.quaternion),p=!1,!0)}}(),this.dispose=function(){n.domElement.removeEventListener("contextmenu",q),n.domElement.removeEventListener("pointerdown",Y),n.domElement.removeEventListener("wheel",G),n.domElement.removeEventListener("touchstart",I),n.domElement.removeEventListener("touchend",Z),n.domElement.removeEventListener("touchmove",X),n.domElement.ownerDocument.removeEventListener("pointermove",V),n.domElement.ownerDocument.removeEventListener("pointerup",H),null!==n._domElementKeyEvents&&n._domElementKeyEvents.removeEventListener("keydown",B)};const n=this,i={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let s=i.NONE;const h=1e-6,u=new t.Spherical,l=new t.Spherical;let m=1;const d=new t.Vector3;let p=!1;const f=new t.Vector2,g=new t.Vector2,b=new t.Vector2,w=new t.Vector2,E=new t.Vector2,y=new t.Vector2,v=new t.Vector2,M=new t.Vector2,T=new t.Vector2;function A(){return Math.pow(.95,n.zoomSpeed)}function O(e){l.theta-=e}function P(e){l.phi-=e}const k=function(){const e=new t.Vector3;return function(t,o){e.setFromMatrixColumn(o,0),e.multiplyScalar(-t),d.add(e)}}(),x=function(){const e=new t.Vector3;return function(t,o){!0===n.screenSpacePanning?e.setFromMatrixColumn(o,1):(e.setFromMatrixColumn(o,0),e.crossVectors(n.object.up,e)),e.multiplyScalar(t),d.add(e)}}(),R=function(){const e=new t.Vector3;return function(t,o){const i=n.domElement;if(n.object.isPerspectiveCamera){const s=n.object.position;e.copy(s).sub(n.target);let a=e.length();a*=Math.tan(n.object.fov/2*Math.PI/180),k(2*t*a/i.clientHeight,n.object.matrix),x(2*o*a/i.clientHeight,n.object.matrix)}else n.object.isOrthographicCamera?(k(t*(n.object.right-n.object.left)/n.object.zoom/i.clientWidth,n.object.matrix),x(o*(n.object.top-n.object.bottom)/n.object.zoom/i.clientHeight,n.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),n.enablePan=!1)}}();function D(e){n.object.isPerspectiveCamera?m/=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom*e)),n.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function L(e){n.object.isPerspectiveCamera?m*=e:n.object.isOrthographicCamera?(n.object.zoom=Math.max(n.minZoom,Math.min(n.maxZoom,n.object.zoom/e)),n.object.updateProjectionMatrix(),p=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),n.enableZoom=!1)}function N(e){f.set(e.clientX,e.clientY)}function S(e){w.set(e.clientX,e.clientY)}function j(e){if(1==e.touches.length)f.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);f.set(t,o)}}function U(e){if(1==e.touches.length)w.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);w.set(t,o)}}function _(e){const t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);v.set(0,n)}function z(e){if(1==e.touches.length)g.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);g.set(t,o)}b.subVectors(g,f).multiplyScalar(n.rotateSpeed);const t=n.domElement;O(2*Math.PI*b.x/t.clientHeight),P(2*Math.PI*b.y/t.clientHeight),f.copy(g)}function C(e){if(1==e.touches.length)E.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);E.set(t,o)}y.subVectors(E,w).multiplyScalar(n.panSpeed),R(y.x,y.y),w.copy(E)}function F(e){const t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+o*o);M.set(0,i),T.set(0,Math.pow(M.y/v.y,n.zoomSpeed)),D(T.y),v.copy(M)}function Y(e){if(!1!==n.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){let o;switch(e.preventDefault(),n.domElement.focus?n.domElement.focus():window.focus(),e.button){case 0:o=n.mouseButtons.LEFT;break;case 1:o=n.mouseButtons.MIDDLE;break;case 2:o=n.mouseButtons.RIGHT;break;default:o=-1}switch(o){case t.MOUSE.DOLLY:if(!1===n.enableZoom)return;!function(e){v.set(e.clientX,e.clientY)}(e),s=i.DOLLY;break;case t.MOUSE.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enablePan)return;S(e),s=i.PAN}else{if(!1===n.enableRotate)return;N(e),s=i.ROTATE}break;case t.MOUSE.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===n.enableRotate)return;N(e),s=i.ROTATE}else{if(!1===n.enablePan)return;S(e),s=i.PAN}break;default:s=i.NONE}s!==i.NONE&&(n.domElement.ownerDocument.addEventListener("pointermove",V),n.domElement.ownerDocument.addEventListener("pointerup",H),n.dispatchEvent(r))}(e)}}function V(e){if(!1!==n.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){if(!1===n.enabled)return;switch(e.preventDefault(),s){case i.ROTATE:if(!1===n.enableRotate)return;!function(e){g.set(e.clientX,e.clientY),b.subVectors(g,f).multiplyScalar(n.rotateSpeed);const t=n.domElement;O(2*Math.PI*b.x/t.clientHeight),P(2*Math.PI*b.y/t.clientHeight),f.copy(g),n.update()}(e);break;case i.DOLLY:if(!1===n.enableZoom)return;!function(e){M.set(e.clientX,e.clientY),T.subVectors(M,v),T.y>0?D(A()):T.y<0&&L(A()),v.copy(M),n.update()}(e);break;case i.PAN:if(!1===n.enablePan)return;!function(e){E.set(e.clientX,e.clientY),y.subVectors(E,w).multiplyScalar(n.panSpeed),R(y.x,y.y),w.copy(E),n.update()}(e)}}(e)}}function H(e){switch(e.pointerType){case"mouse":case"pen":!function(e){if(n.domElement.ownerDocument.removeEventListener("pointermove",V),n.domElement.ownerDocument.removeEventListener("pointerup",H),!1===n.enabled)return;n.dispatchEvent(c),s=i.NONE}()}}function G(e){!1===n.enabled||!1===n.enableZoom||s!==i.NONE&&s!==i.ROTATE||(e.preventDefault(),n.dispatchEvent(r),function(e){e.deltaY<0?L(A()):e.deltaY>0&&D(A()),n.update()}(e),n.dispatchEvent(c))}function B(e){!1!==n.enabled&&!1!==n.enablePan&&function(e){let t=!1;switch(e.code){case n.keys.UP:R(0,n.keyPanSpeed),t=!0;break;case n.keys.BOTTOM:R(0,-n.keyPanSpeed),t=!0;break;case n.keys.LEFT:R(n.keyPanSpeed,0),t=!0;break;case n.keys.RIGHT:R(-n.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),n.update())}(e)}function I(e){if(!1!==n.enabled){switch(e.preventDefault(),e.touches.length){case 1:switch(n.touches.ONE){case t.TOUCH.ROTATE:if(!1===n.enableRotate)return;j(e),s=i.TOUCH_ROTATE;break;case t.TOUCH.PAN:if(!1===n.enablePan)return;U(e),s=i.TOUCH_PAN;break;default:s=i.NONE}break;case 2:switch(n.touches.TWO){case t.TOUCH.DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&_(e),n.enablePan&&U(e)}(e),s=i.TOUCH_DOLLY_PAN;break;case t.TOUCH.DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&_(e),n.enableRotate&&j(e)}(e),s=i.TOUCH_DOLLY_ROTATE;break;default:s=i.NONE}break;default:s=i.NONE}s!==i.NONE&&n.dispatchEvent(r)}}function X(e){if(!1!==n.enabled)switch(e.preventDefault(),s){case i.TOUCH_ROTATE:if(!1===n.enableRotate)return;z(e),n.update();break;case i.TOUCH_PAN:if(!1===n.enablePan)return;C(e),n.update();break;case i.TOUCH_DOLLY_PAN:if(!1===n.enableZoom&&!1===n.enablePan)return;!function(e){n.enableZoom&&F(e),n.enablePan&&C(e)}(e),n.update();break;case i.TOUCH_DOLLY_ROTATE:if(!1===n.enableZoom&&!1===n.enableRotate)return;!function(e){n.enableZoom&&F(e),n.enableRotate&&z(e)}(e),n.update();break;default:s=i.NONE}}function Z(e){!1!==n.enabled&&(n.dispatchEvent(c),s=i.NONE)}function q(e){!1!==n.enabled&&e.preventDefault()}n.domElement.addEventListener("contextmenu",q),n.domElement.addEventListener("pointerdown",Y),n.domElement.addEventListener("wheel",G,{passive:!1}),n.domElement.addEventListener("touchstart",I,{passive:!1}),n.domElement.addEventListener("touchend",Z),n.domElement.addEventListener("touchmove",X,{passive:!1}),this.update()}}class u{animation;currentEffectIndex=0;effects;tickingEffects=[];constructor(e,t){this.animation=e,this.effects=Object.entries(t).map((([e,t])=>[Number(e),Array.isArray(t)?t:[t]])).sort((([e],[t])=>e-t))}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const e=this.effects[this.currentEffectIndex];return e[0]>this.animation.roundedCurrentTime?void 0:(this.currentEffectIndex++,e[1])}reset(){this.currentEffectIndex=0}}class l extends u{tick(){const e=super.getCurrentEffects()??[];e.length>0&&console.log(`Playing sound effects: "${e.map((e=>e.effect)).join(", ")}"`)}}class m extends u{disposables=[];tick(){this.tickingEffects.forEach((e=>e.tick()));const e=super.getCurrentEffects()??[];for(const{locator:t,effect:o,pre_effect_script:n}of e){if(!o)return;const e=this.animation.getAnimator(),n=e.getModel(),i=e.getEmitter(o);if(!i||!e.winterskyScene)return;const a=t?n.getLocator(t):void 0,r=new s.default.Emitter(e.winterskyScene,i,{parent_mode:a?"locator":"entity",loop_mode:"once"});a&&(a.add(r.local_space),r.local_space.parent=a);const c={tick:()=>{r.tick(),r.enabled||(r.delete(),this.tickingEffects=this.tickingEffects.filter((e=>e!==c)))}};this.tickingEffects.push(c),this.disposables.push({dispose:()=>{r.delete(),this.tickingEffects=this.tickingEffects.filter((e=>e!==c))}}),r.start(),r.tick()}}dispose(){this.disposables.forEach((e=>e.dispose())),this.disposables=[]}}class d{animator;animationData;startTimestamp=0;lastFrameTimestamp=0;isRunning=!1;env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime};molang=new o.MoLang(this.env);soundEffects;particleEffects;constructor(e,t){this.animator=e,this.animationData=t,this.soundEffects=new l(this,this.animationData.sound_effects??{}),this.particleEffects=new m(this,this.animationData.particle_effects??{})}getAnimator(){return this.animator}execute(e){return this.molang.executeAndCatch(e)}parseBoneModifier(e){if("number"==typeof e)return[e,e,e];if("string"==typeof e){const t="string"==typeof e?this.execute(e):e;return[t,t,t]}if(Array.isArray(e))return e.map((e=>"string"==typeof e?this.execute(e):e));if(void 0!==e){const o=Object.entries(e).map((([e,t])=>[Number(e),t])).sort((([e],[t])=>e-t));for(let e=o.length-1;e>=0;e--){let[n,i]=o[e];if(!(n>this.currentTime)){if(n===this.currentTime){if(Array.isArray(i))return i;throw new Error("Format not supported yet")}{let[s,a]=o[t.MathUtils.euclideanModulo(e+1,o.length)],r=s-n;if(Array.isArray(i)&&Array.isArray(a))return i.map(((e,t)=>e+(a[t]-e)/r*(this.currentTime-n)));throw new Error("Format not supported yet")}}}return[0,0,0]}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const e=this.animator.getModel().getBoneMap();for(let o in this.animationData.bones){const n=e.get(o);if(!n)continue;const{position:i,rotation:s,scale:a}=this.animationData.bones[o],[r,c,h]=[i,s,a].map((e=>this.parseBoneModifier(e)));if(r){const e=n.position.toArray();n.position.set(...r.map(((t,o)=>(0===o?-1:1)*t+e[o])))}if(c){const e=n.rotation.toArray();n.rotation.set(...c.map(t.MathUtils.degToRad).map(((t,o)=>e[o]+(2===o?t:-t))))}h&&n.scale.set(...h)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class p{model;winterskyScene;animations=new Map;particleEmitters=new Map;constructor(e){this.model=e}setupDefaultBonePoses(){for(let e of this.model.getBoneMap().values())e.userData.defaultRotation=e.rotation.toArray(),e.userData.defaultPosition=e.position.toArray()}dispose(){this.disposeAnimations();for(let e of this.model.getBoneMap().values())delete e.userData.defaultRotation,delete e.userData.defaultPosition}disposeAnimations(){this.animations.forEach((e=>e.dispose()))}setupWintersky(e){this.winterskyScene=e}addAnimation(e,t){this.animations.set(e,new d(this,t))}addEmitter(e,t){this.particleEmitters.set(e,t)}getEmitter(e){return this.particleEmitters.get(e)}play(e){const t=this.animations.get(e);if(!t)throw new Error(`Unknown animation: "${e}"`);t.play()}pause(e){const t=this.animations.get(e);if(!t)throw new Error(`Unknown animation: "${e}"`);t.pause()}pauseAll(){for(const e of this.animations.values())e.pause()}tick(){for(let e of this.model.getBoneMap().values())e.rotation.set(...e.userData.defaultRotation),e.position.set(...e.userData.defaultPosition);this.animations.forEach((e=>e.shouldTick&&e.tick()))}get shouldTick(){return[...this.animations.values()].some((e=>e.shouldTick))}getModel(){return this.model}}const f=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}];class g{positions=[];indices=[];normals=[];uvs=[];geometry=new t.BufferGeometry;group=new t.Group;constructor(e){const{textureSize:[t,o],textureDiscrepancyFactor:[n,i],mirror:s,width:a,height:r,depth:c}=e,h=e.startUV??[0,0],u=!Array.isArray(h);let l=0,m=0;u||([l,m]=h);const[d,p]=[t*n,o*i];for(let{name:e,dir:t,corners:o,baseUV:[g,b]}of f){const f=this.positions.length/3;let w,E;if(u){if(void 0===h[e])continue;[l,m]=h[e]?.uv||[],[w,E]=h[e]?.uv_size||[],w*=n,E*=i,l*=n,m*=i,g=0,b=0}for(const{pos:[n,i,h],uv:u}of o)this.positions.push((s?-n:n)*a,i*r,h*c),this.normals.push(...t),this.uvs.push((l+(Number(g>0)+Number(g>2))*Math.floor(w??c)+Number(g>1)*Math.floor(w??a)+u[0]*("west"===e||"east"===e?Math.floor(w??c):Math.floor(w??a)))/d,1-(m+b*Math.floor(E??c)+("up"===e||"down"===e?Math.floor(E??c):Math.floor(E??r))-u[1]*("up"===e||"down"===e?Math.floor(E??c):Math.floor(E??r)))/p);this.indices.push(f,f+1,f+2,f+2,f+1,f+3)}this.createGeometry(),this.createMesh(e)}createGeometry(){this.geometry.setAttribute("position",new t.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new t.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new t.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:e,width:o,height:n,depth:i,pivot:s,rotation:a,origin:r,inflate:c=0}){const h=2*c+o,u=new t.Mesh(this.geometry,e);if(this.group.rotation.order="ZYX",void 0===s&&(s=[h/2,n/2,i/2]),this.group.add(u),a){this.group.position.set(-s[0],s[1],s[2]),u.position.set(-r[0]-h/2+s[0]+c,r[1]-s[1]-c,r[2]-s[2]-c);const[e,o,n]=a;this.group.rotation.set(t.MathUtils.degToRad(-e),t.MathUtils.degToRad(-o),t.MathUtils.degToRad(n))}else this.group.position.set(-r[0]-h/2+c,r[1]-c,r[2]-c);c&&this.group.scale.set(0!==o?1+c/(o/2):1,0!==n?1+c/(n/2):1,0!==i?1+c/(i/2):1)}getGroup(){return this.group}}class b{positions=[];indices=[];normals=[];uvs=[];geometry=new t.BufferGeometry;group=new t.Group;constructor(e){if(!Array.isArray(e.polys))throw new Error("Format not supported yet!");e.normalized_uvs||(e.uvs=e?.uvs?.map((([t,o])=>[t/e.textureSize[0],o/e.textureSize[1]])));let t=0;for(const o of e.polys){for(const[t,n,i]of o)this.positions.push(...e?.positions?.[t]??[]),this.normals.push(...e?.normals?.[n]??[]),this.uvs.push(...e?.uvs?.[i]??[]);3===o.length?this.indices.push(t,t+1,t+2):this.indices.push(t+2,t+1,t,t+2,t,t+3),t+=o.length}this.createGeometry(),this.createMesh(e)}createGeometry(){this.geometry.setAttribute("position",new t.BufferAttribute(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new t.BufferAttribute(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new t.BufferAttribute(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:e}){const o=new t.Mesh(this.geometry,e);this.group.add(o)}getGroup(){return this.group}}class w{modelData;texturePath;model;boneMap=new Map;locators=new Map;animator=new p(this);constructor(e,o){this.modelData=e,this.texturePath=o;const n=e?.description?.identifier??"geometry.unknown";this.model=new t.Group,this.model.name=n}async create(){const e=this.modelData,o=await this.loadTexture(this.texturePath),n=[e?.description?.texture_width??o.image.width,e?.description?.texture_height??o.image.height],i=[o.image.width/n[0],o.image.height/n[1]],s=new Map;o.magFilter=t.NearestFilter,o.minFilter=t.NearestFilter;const a=new t.MeshLambertMaterial({side:t.DoubleSide,alphaTest:.2,transparent:!0,map:o});e?.bones?.forEach((e=>{const o=new t.Group;if(o.name=e.name??"unknown",e.poly_mesh){const t=new b({...e.poly_mesh,textureSize:n,material:a,mirror:e.mirror??!1,origin:[0,0,0],inflate:e.inflate,rotation:[0,0,0],pivot:e.pivot}).getGroup();t.name=`#bone.${e.name}#polyMesh`,o.add(t)}e.cubes?.forEach(((t,s)=>{const r=new g({width:t.size?.[0]??0,height:t.size?.[1]??0,depth:t.size?.[2]??0,startUV:t.uv,textureSize:n,textureDiscrepancyFactor:i,material:a,mirror:void 0===t.mirror&&void 0===t.rotation?e.mirror??!1:t.mirror??!1,origin:t.origin??[0,0,0],inflate:t.inflate??e.inflate,rotation:t.rotation,pivot:t.pivot??e.pivot}).getGroup();r.name=`#bone.${e.name}#cube.${s}`,o.add(r)}));const r=new t.Group;if(r.rotation.order="ZYX",e.pivot){const[t,n,i]=e.pivot;r.position.set(-t,n,i),o.position.set(t,-n,-i)}else r.position.set(0,0,0);if(r.add(o),r.name="#pivot."+e.name,e.rotation){const[o,n,i]=e.rotation;r.rotation.set(t.MathUtils.degToRad(-o),t.MathUtils.degToRad(-n),t.MathUtils.degToRad(i))}const c=e.locators??{};for(const e in c){const o=new t.Group;o.name="locator#"+e;const n=c[e];Array.isArray(n)?o.position.set(...n):"object"==typeof n&&(o.position.set(...n.offset??[0,0,0]),o.rotation.set(...n.rotation??[0,0,0])),this.locators.set(e,o),r.add(o)}e.parent||this.model.add(r),e.name&&(s.set(e.name,[e.parent,r]),this.boneMap.set(e.name,r))}));for(let[e,[t,o]]of s)if(t){const e=s.get(t)?.[1];e&&e.name.startsWith("#pivot.")?e.children[0].add(o):e&&e.add(o)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(e){return this.locators.get(e)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(e,o,n){const i=new t.LineBasicMaterial({side:t.DoubleSide,color:e,linewidth:20}),s=new t.BoxGeometry(n.x,n.y,n.z),a=new t.EdgesGeometry(s),r=new t.LineSegments(a,i);return r.position.set(o.x,o.y+n.y/2,o.z),r.name="helperBox",this.model.add(r),{dispose:()=>{this.model.remove(r)}}}dispose(){this.animator.dispose()}loadTexture(e){return new Promise(((o,n)=>{(new t.TextureLoader).load(e,(e=>{o(e)}))}))}}return e.Model=w,e.StandaloneModelViewer=class{canvasElement;texturePath;options;renderer;model;scene;camera;renderingRequested=!1;controls;loadedModel;constructor(e,o,n,i){this.canvasElement=e,this.texturePath=n,this.options=i,this.renderer=new t.WebGLRenderer({canvas:e,antialias:i.antialias??!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new t.PerspectiveCamera(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new h(this.camera,e),this.scene=new t.Scene,this.scene.add(new t.AmbientLight(16777215)),this.scene.background=new t.Color(13299960),this.model=new w(o,n),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",(()=>this.requestRendering())),this.onResize(),this.loadedModel=this.loadModel().then((()=>this.requestRendering()))}async loadModel(){await this.model.create()}get width(){return this.options.width??window.innerWidth}get height(){return this.options.height??window.innerHeight}render(e=!0){this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,e&&this.model.shouldTick&&(this.model.tick(),this.model.animator.winterskyScene?.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(e=!1){if(e)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame((()=>this.render())))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new t.AxesHelper(50)),this.scene.add(new t.GridHelper(20,20)),this.scene.add(new t.BoxHelper(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(e=1.5,o=!0){o&&this.model.getGroup().rotation.set(0,Math.PI,0);const n=(new t.Box3).setFromObject(this.model.getGroup()).getBoundingSphere(new t.Sphere),i=this.camera.fov*Math.PI/180*e,s=n.radius/Math.tan(i/2),a=Math.sqrt(Math.pow(s,2)+Math.pow(s,2));this.camera.position.set(a,a,a),this.controls.update(),this.camera.lookAt(n.center),this.controls.target.set(n.center.x,n.center.y,n.center.z),this.camera.updateProjectionMatrix()}},Object.defineProperty(e,"__esModule",{value:!0}),e}({},three,molang,Wintersky);
