import{EventDispatcher as e,Vector3 as t,MOUSE as o,TOUCH as n,Quaternion as i,Spherical as s,Vector2 as a,MathUtils as r,BufferGeometry as c,Group as h,BufferAttribute as u,Mesh as m,NearestFilter as l,MeshLambertMaterial as d,DoubleSide as p,LineBasicMaterial as f,BoxGeometry as g,EdgesGeometry as w,LineSegments as b,TextureLoader as E,WebGLRenderer as y,PerspectiveCamera as v,Scene as T,AmbientLight as A,Color as M,AxesHelper as k,GridHelper as P,BoxHelper as O,Box3 as x,Sphere as R}from"three";import{MoLang as D}from"molang";import L from"wintersky";const N={type:"change"},j={type:"start"},z={type:"end"};class _ extends e{constructor(e,r){super(),void 0===r&&console.warn('THREE.OrbitControls: The second parameter "domElement" is now mandatory.'),r===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.object=e,this.domElement=r,this.enabled=!0,this.target=new t,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!1,this.dampingFactor=.05,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=1,this.enablePan=!0,this.panSpeed=1,this.screenSpacePanning=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.keys={LEFT:"ArrowLeft",UP:"ArrowUp",RIGHT:"ArrowRight",BOTTOM:"ArrowDown"},this.mouseButtons={LEFT:o.ROTATE,MIDDLE:o.DOLLY,RIGHT:o.PAN},this.touches={ONE:n.ROTATE,TWO:n.DOLLY_PAN},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this._domElementKeyEvents=null,this.getPolarAngle=function(){return l.phi},this.getAzimuthalAngle=function(){return l.theta},this.listenToKeyEvents=function(e){e.addEventListener("keydown",K),this._domElementKeyEvents=e},this.saveState=function(){c.target0.copy(c.target),c.position0.copy(c.object.position),c.zoom0=c.object.zoom},this.reset=function(){c.target.copy(c.target0),c.object.position.copy(c.position0),c.object.zoom=c.zoom0,c.object.updateProjectionMatrix(),c.dispatchEvent(N),c.update(),u=h.NONE},this.update=function(){const o=new t,n=(new i).setFromUnitVectors(e.up,new t(0,1,0)),s=n.clone().invert(),a=new t,r=new i,w=2*Math.PI;return function(){const e=c.object.position;o.copy(e).sub(c.target),o.applyQuaternion(n),l.setFromVector3(o),c.autoRotate&&u===h.NONE&&O(2*Math.PI/60/60*c.autoRotateSpeed),c.enableDamping?(l.theta+=d.theta*c.dampingFactor,l.phi+=d.phi*c.dampingFactor):(l.theta+=d.theta,l.phi+=d.phi);let t=c.minAzimuthAngle,i=c.maxAzimuthAngle;return isFinite(t)&&isFinite(i)&&(t<-Math.PI?t+=w:t>Math.PI&&(t-=w),i<-Math.PI?i+=w:i>Math.PI&&(i-=w),l.theta=t<=i?Math.max(t,Math.min(i,l.theta)):l.theta>(t+i)/2?Math.max(t,l.theta):Math.min(i,l.theta)),l.phi=Math.max(c.minPolarAngle,Math.min(c.maxPolarAngle,l.phi)),l.makeSafe(),l.radius*=p,l.radius=Math.max(c.minDistance,Math.min(c.maxDistance,l.radius)),!0===c.enableDamping?c.target.addScaledVector(f,c.dampingFactor):c.target.add(f),o.setFromSpherical(l),o.applyQuaternion(s),e.copy(c.target).add(o),c.object.lookAt(c.target),!0===c.enableDamping?(d.theta*=1-c.dampingFactor,d.phi*=1-c.dampingFactor,f.multiplyScalar(1-c.dampingFactor)):(d.set(0,0,0),f.set(0,0,0)),p=1,!!(g||a.distanceToSquared(c.object.position)>m||8*(1-r.dot(c.object.quaternion))>m)&&(c.dispatchEvent(N),a.copy(c.object.position),r.copy(c.object.quaternion),g=!1,!0)}}(),this.dispose=function(){c.domElement.removeEventListener("contextmenu",J),c.domElement.removeEventListener("pointerdown",q),c.domElement.removeEventListener("wheel",V),c.domElement.removeEventListener("touchstart",W),c.domElement.removeEventListener("touchend",Q),c.domElement.removeEventListener("touchmove",$),c.domElement.ownerDocument.removeEventListener("pointermove",G),c.domElement.ownerDocument.removeEventListener("pointerup",B),null!==c._domElementKeyEvents&&c._domElementKeyEvents.removeEventListener("keydown",K)};const c=this,h={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_PAN:4,TOUCH_DOLLY_PAN:5,TOUCH_DOLLY_ROTATE:6};let u=h.NONE;const m=1e-6,l=new s,d=new s;let p=1;const f=new t;let g=!1;const w=new a,b=new a,E=new a,y=new a,v=new a,T=new a,A=new a,M=new a,k=new a;function P(){return Math.pow(.95,c.zoomSpeed)}function O(e){d.theta-=e}function x(e){d.phi-=e}const R=function(){const e=new t;return function(t,o){e.setFromMatrixColumn(o,0),e.multiplyScalar(-t),f.add(e)}}(),D=function(){const e=new t;return function(t,o){!0===c.screenSpacePanning?e.setFromMatrixColumn(o,1):(e.setFromMatrixColumn(o,0),e.crossVectors(c.object.up,e)),e.multiplyScalar(t),f.add(e)}}(),L=function(){const e=new t;return function(t,o){const n=c.domElement;if(c.object.isPerspectiveCamera){const i=c.object.position;e.copy(i).sub(c.target);let s=e.length();s*=Math.tan(c.object.fov/2*Math.PI/180),R(2*t*s/n.clientHeight,c.object.matrix),D(2*o*s/n.clientHeight,c.object.matrix)}else c.object.isOrthographicCamera?(R(t*(c.object.right-c.object.left)/c.object.zoom/n.clientWidth,c.object.matrix),D(o*(c.object.top-c.object.bottom)/c.object.zoom/n.clientHeight,c.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),c.enablePan=!1)}}();function _(e){c.object.isPerspectiveCamera?p/=e:c.object.isOrthographicCamera?(c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom*e)),c.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function S(e){c.object.isPerspectiveCamera?p*=e:c.object.isOrthographicCamera?(c.object.zoom=Math.max(c.minZoom,Math.min(c.maxZoom,c.object.zoom/e)),c.object.updateProjectionMatrix(),g=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),c.enableZoom=!1)}function Y(e){w.set(e.clientX,e.clientY)}function F(e){y.set(e.clientX,e.clientY)}function C(e){if(1==e.touches.length)w.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);w.set(t,o)}}function I(e){if(1==e.touches.length)y.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);y.set(t,o)}}function H(e){const t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);A.set(0,n)}function U(e){if(1==e.touches.length)b.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);b.set(t,o)}E.subVectors(b,w).multiplyScalar(c.rotateSpeed);const t=c.domElement;O(2*Math.PI*E.x/t.clientHeight),x(2*Math.PI*E.y/t.clientHeight),w.copy(b)}function X(e){if(1==e.touches.length)v.set(e.touches[0].pageX,e.touches[0].pageY);else{const t=.5*(e.touches[0].pageX+e.touches[1].pageX),o=.5*(e.touches[0].pageY+e.touches[1].pageY);v.set(t,o)}T.subVectors(v,y).multiplyScalar(c.panSpeed),L(T.x,T.y),y.copy(v)}function Z(e){const t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(t*t+o*o);M.set(0,n),k.set(0,Math.pow(M.y/A.y,c.zoomSpeed)),_(k.y),A.copy(M)}function q(e){if(!1!==c.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){let t;switch(e.preventDefault(),c.domElement.focus?c.domElement.focus():window.focus(),e.button){case 0:t=c.mouseButtons.LEFT;break;case 1:t=c.mouseButtons.MIDDLE;break;case 2:t=c.mouseButtons.RIGHT;break;default:t=-1}switch(t){case o.DOLLY:if(!1===c.enableZoom)return;!function(e){A.set(e.clientX,e.clientY)}(e),u=h.DOLLY;break;case o.ROTATE:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enablePan)return;F(e),u=h.PAN}else{if(!1===c.enableRotate)return;Y(e),u=h.ROTATE}break;case o.PAN:if(e.ctrlKey||e.metaKey||e.shiftKey){if(!1===c.enableRotate)return;Y(e),u=h.ROTATE}else{if(!1===c.enablePan)return;F(e),u=h.PAN}break;default:u=h.NONE}u!==h.NONE&&(c.domElement.ownerDocument.addEventListener("pointermove",G),c.domElement.ownerDocument.addEventListener("pointerup",B),c.dispatchEvent(j))}(e)}}function G(e){if(!1!==c.enabled)switch(e.pointerType){case"mouse":case"pen":!function(e){if(!1===c.enabled)return;switch(e.preventDefault(),u){case h.ROTATE:if(!1===c.enableRotate)return;!function(e){b.set(e.clientX,e.clientY),E.subVectors(b,w).multiplyScalar(c.rotateSpeed);const t=c.domElement;O(2*Math.PI*E.x/t.clientHeight),x(2*Math.PI*E.y/t.clientHeight),w.copy(b),c.update()}(e);break;case h.DOLLY:if(!1===c.enableZoom)return;!function(e){M.set(e.clientX,e.clientY),k.subVectors(M,A),k.y>0?_(P()):k.y<0&&S(P()),A.copy(M),c.update()}(e);break;case h.PAN:if(!1===c.enablePan)return;!function(e){v.set(e.clientX,e.clientY),T.subVectors(v,y).multiplyScalar(c.panSpeed),L(T.x,T.y),y.copy(v),c.update()}(e)}}(e)}}function B(e){switch(e.pointerType){case"mouse":case"pen":!function(e){if(c.domElement.ownerDocument.removeEventListener("pointermove",G),c.domElement.ownerDocument.removeEventListener("pointerup",B),!1===c.enabled)return;c.dispatchEvent(z),u=h.NONE}()}}function V(e){!1===c.enabled||!1===c.enableZoom||u!==h.NONE&&u!==h.ROTATE||(e.preventDefault(),c.dispatchEvent(j),function(e){e.deltaY<0?S(P()):e.deltaY>0&&_(P()),c.update()}(e),c.dispatchEvent(z))}function K(e){!1!==c.enabled&&!1!==c.enablePan&&function(e){let t=!1;switch(e.code){case c.keys.UP:L(0,c.keyPanSpeed),t=!0;break;case c.keys.BOTTOM:L(0,-c.keyPanSpeed),t=!0;break;case c.keys.LEFT:L(c.keyPanSpeed,0),t=!0;break;case c.keys.RIGHT:L(-c.keyPanSpeed,0),t=!0}t&&(e.preventDefault(),c.update())}(e)}function W(e){if(!1!==c.enabled){switch(e.preventDefault(),e.touches.length){case 1:switch(c.touches.ONE){case n.ROTATE:if(!1===c.enableRotate)return;C(e),u=h.TOUCH_ROTATE;break;case n.PAN:if(!1===c.enablePan)return;I(e),u=h.TOUCH_PAN;break;default:u=h.NONE}break;case 2:switch(c.touches.TWO){case n.DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(e){c.enableZoom&&H(e),c.enablePan&&I(e)}(e),u=h.TOUCH_DOLLY_PAN;break;case n.DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(e){c.enableZoom&&H(e),c.enableRotate&&C(e)}(e),u=h.TOUCH_DOLLY_ROTATE;break;default:u=h.NONE}break;default:u=h.NONE}u!==h.NONE&&c.dispatchEvent(j)}}function $(e){if(!1!==c.enabled)switch(e.preventDefault(),u){case h.TOUCH_ROTATE:if(!1===c.enableRotate)return;U(e),c.update();break;case h.TOUCH_PAN:if(!1===c.enablePan)return;X(e),c.update();break;case h.TOUCH_DOLLY_PAN:if(!1===c.enableZoom&&!1===c.enablePan)return;!function(e){c.enableZoom&&Z(e),c.enablePan&&X(e)}(e),c.update();break;case h.TOUCH_DOLLY_ROTATE:if(!1===c.enableZoom&&!1===c.enableRotate)return;!function(e){c.enableZoom&&Z(e),c.enableRotate&&U(e)}(e),c.update();break;default:u=h.NONE}}function Q(e){!1!==c.enabled&&(c.dispatchEvent(z),u=h.NONE)}function J(e){!1!==c.enabled&&e.preventDefault()}c.domElement.addEventListener("contextmenu",J),c.domElement.addEventListener("pointerdown",q),c.domElement.addEventListener("wheel",V,{passive:!1}),c.domElement.addEventListener("touchstart",W,{passive:!1}),c.domElement.addEventListener("touchend",Q),c.domElement.addEventListener("touchmove",$,{passive:!1}),this.update()}}class S{animation;currentEffectIndex=0;effects;tickingEffects=[];constructor(e,t){this.animation=e,this.effects=Object.entries(t).map((([e,t])=>[Number(e),Array.isArray(t)?t:[t]])).sort((([e],[t])=>e-t))}getCurrentEffects(){if(this.currentEffectIndex>=this.effects.length)return;const e=this.effects[this.currentEffectIndex];return e[0]>this.animation.roundedCurrentTime?void 0:(this.currentEffectIndex++,e[1])}reset(){this.currentEffectIndex=0}}class Y extends S{tick(){const e=super.getCurrentEffects()??[];e.length>0&&console.log(`Playing sound effects: "${e.map((e=>e.effect)).join(", ")}"`)}}class F extends S{disposables=[];tick(){this.tickingEffects.forEach((e=>e.tick()));const e=super.getCurrentEffects()??[];for(const{locator:t,effect:o,pre_effect_script:n}of e){if(!o)return;const e=this.animation.getAnimator(),n=e.getModel(),i=e.getEmitter(o);if(!i||!e.winterskyScene)return;const s=t?n.getLocator(t):void 0,a=new L.Emitter(e.winterskyScene,i,{parent_mode:s?"locator":"entity",loop_mode:"once"});s&&(s.add(a.local_space),a.local_space.parent=s);const r={tick:()=>{a.tick(),a.enabled||(a.delete(),this.tickingEffects=this.tickingEffects.filter((e=>e!==r)))}};this.tickingEffects.push(r),this.disposables.push({dispose:()=>{a.delete(),this.tickingEffects=this.tickingEffects.filter((e=>e!==r))}}),a.start(),a.tick()}}dispose(){this.disposables.forEach((e=>e.dispose())),this.disposables=[]}}class C{animator;animationData;startTimestamp=0;lastFrameTimestamp=0;isRunning=!1;env={"query.anim_time":()=>this.currentTime,"query.delta_time":()=>this.startTimestamp-this.lastFrameTimestamp,"query.life_time":()=>this.currentTime};molang=new D(this.env);soundEffects;particleEffects;constructor(e,t){this.animator=e,this.animationData=t,this.soundEffects=new Y(this,this.animationData.sound_effects??{}),this.particleEffects=new F(this,this.animationData.particle_effects??{})}getAnimator(){return this.animator}execute(e){return this.molang.executeAndCatch(e)}parseBoneModifier(e){if("number"==typeof e)return[e,e,e];if("string"==typeof e){const t="string"==typeof e?this.execute(e):e;return[t,t,t]}if(Array.isArray(e))return e.map((e=>"string"==typeof e?this.execute(e):e));if(void 0!==e){const t=Object.entries(e).map((([e,t])=>[Number(e),t])).sort((([e],[t])=>e-t));for(let e=t.length-1;e>=0;e--){let[o,n]=t[e];if(!(o>this.currentTime)){if(o===this.currentTime){if(Array.isArray(n))return n;throw new Error("Format not supported yet")}{let[i,s]=t[r.euclideanModulo(e+1,t.length)],a=i-o;if(Array.isArray(n)&&Array.isArray(s))return n.map(((e,t)=>e+(s[t]-e)/a*(this.currentTime-o)));throw new Error("Format not supported yet")}}}return[0,0,0]}}tick(){this.soundEffects.tick(),this.particleEffects.tick();const e=this.animator.getModel().getBoneMap();for(let t in this.animationData.bones){const o=e.get(t);if(!o)continue;const{position:n,rotation:i,scale:s}=this.animationData.bones[t],[a,c,h]=[n,i,s].map((e=>this.parseBoneModifier(e)));if(a){const e=o.position.toArray();o.position.set(...a.map(((t,o)=>(0===o?-1:1)*t+e[o])))}if(c){const e=o.rotation.toArray();o.rotation.set(...c.map(r.degToRad).map(((t,o)=>e[o]+(2===o?t:-t))))}h&&o.scale.set(...h)}this.currentTime>this.animationData.animation_length&&(this.animationData.loop?this.loop():this.pause()),this.lastFrameTimestamp=Date.now()}play(){this.isRunning=!0,this.startTimestamp=Date.now()}pause(){this.isRunning=!1}loop(){this.startTimestamp=Date.now(),this.soundEffects.reset(),this.particleEffects.reset()}dispose(){this.particleEffects.dispose()}get currentTime(){return(Date.now()-this.startTimestamp)/1e3}get roundedCurrentTime(){return Math.round((Date.now()-this.startTimestamp)/50)/20}get shouldTick(){return this.isRunning}}class I{model;winterskyScene;animations=new Map;particleEmitters=new Map;constructor(e){this.model=e}setupDefaultBonePoses(){for(let e of this.model.getBoneMap().values())e.userData.defaultRotation=e.rotation.toArray(),e.userData.defaultPosition=e.position.toArray()}dispose(){this.disposeAnimations();for(let e of this.model.getBoneMap().values())delete e.userData.defaultRotation,delete e.userData.defaultPosition}disposeAnimations(){this.animations.forEach((e=>e.dispose()))}setupWintersky(e){this.winterskyScene=e}addAnimation(e,t){this.animations.set(e,new C(this,t))}addEmitter(e,t){this.particleEmitters.set(e,t)}getEmitter(e){return this.particleEmitters.get(e)}play(e){const t=this.animations.get(e);if(!t)throw new Error(`Unknown animation: "${e}"`);t.play()}pause(e){const t=this.animations.get(e);if(!t)throw new Error(`Unknown animation: "${e}"`);t.pause()}pauseAll(){for(const e of this.animations.values())e.pause()}tick(){for(let e of this.model.getBoneMap().values())e.rotation.set(...e.userData.defaultRotation),e.position.set(...e.userData.defaultPosition);this.animations.forEach((e=>e.shouldTick&&e.tick()))}get shouldTick(){return[...this.animations.values()].some((e=>e.shouldTick))}getModel(){return this.model}}const H=[{name:"west",baseUV:[2,1],dir:[-1,0,0],corners:[{pos:[-.5,1,0],uv:[0,1]},{pos:[-.5,0,0],uv:[0,0]},{pos:[-.5,1,1],uv:[1,1]},{pos:[-.5,0,1],uv:[1,0]}]},{name:"east",baseUV:[0,1],dir:[1,0,0],corners:[{pos:[.5,1,1],uv:[0,1]},{pos:[.5,0,1],uv:[0,0]},{pos:[.5,1,0],uv:[1,1]},{pos:[.5,0,0],uv:[1,0]}]},{name:"down",baseUV:[2,0],dir:[0,-1,0],corners:[{pos:[.5,0,1],uv:[0,1]},{pos:[-.5,0,1],uv:[1,1]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,0,0],uv:[1,0]}]},{name:"up",baseUV:[1,0],dir:[0,1,0],corners:[{pos:[-.5,1,1],uv:[1,1]},{pos:[.5,1,1],uv:[0,1]},{pos:[-.5,1,0],uv:[1,0]},{pos:[.5,1,0],uv:[0,0]}]},{name:"north",baseUV:[1,1],dir:[0,0,-1],corners:[{pos:[-.5,0,0],uv:[1,0]},{pos:[.5,0,0],uv:[0,0]},{pos:[-.5,1,0],uv:[1,1]},{pos:[.5,1,0],uv:[0,1]}]},{name:"south",baseUV:[3,1],dir:[0,0,1],corners:[{pos:[-.5,0,1],uv:[0,0]},{pos:[.5,0,1],uv:[1,0]},{pos:[-.5,1,1],uv:[0,1]},{pos:[.5,1,1],uv:[1,1]}]}];class U{positions=[];indices=[];normals=[];uvs=[];geometry=new c;group=new h;constructor(e){const{textureSize:[t,o],textureDiscrepancyFactor:[n,i],mirror:s,width:a,height:r,depth:c}=e,h=e.startUV??[0,0],u=!Array.isArray(h);let m=0,l=0;u||([m,l]=h);const[d,p]=[t*n,o*i];for(let{name:e,dir:t,corners:o,baseUV:[f,g]}of H){const w=this.positions.length/3;let b,E;if(u){if(void 0===h[e])continue;[m,l]=h[e]?.uv||[],[b,E]=h[e]?.uv_size||[],b*=n,E*=i,m*=n,l*=i,f=0,g=0}for(const{pos:[n,i,h],uv:u}of o)this.positions.push((s?-n:n)*a,i*r,h*c),this.normals.push(...t),this.uvs.push((m+(Number(f>0)+Number(f>2))*Math.floor(b??c)+Number(f>1)*Math.floor(b??a)+u[0]*("west"===e||"east"===e?Math.floor(b??c):Math.floor(b??a)))/d,1-(l+g*Math.floor(E??c)+("up"===e||"down"===e?Math.floor(E??c):Math.floor(E??r))-u[1]*("up"===e||"down"===e?Math.floor(E??c):Math.floor(E??r)))/p);this.indices.push(w,w+1,w+2,w+2,w+1,w+3)}this.createGeometry(),this.createMesh(e)}createGeometry(){this.geometry.setAttribute("position",new u(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new u(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new u(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:e,width:t,height:o,depth:n,pivot:i,rotation:s,origin:a,inflate:c=0}){const h=2*c+t,u=new m(this.geometry,e);if(this.group.rotation.order="ZYX",void 0===i&&(i=[h/2,o/2,n/2]),this.group.add(u),s){this.group.position.set(-i[0],i[1],i[2]),u.position.set(-a[0]-h/2+i[0]+c,a[1]-i[1]-c,a[2]-i[2]-c);const[e,t,o]=s;this.group.rotation.set(r.degToRad(-e),r.degToRad(-t),r.degToRad(o))}else this.group.position.set(-a[0]-h/2+c,a[1]-c,a[2]-c);c&&this.group.scale.set(0!==t?1+c/(t/2):1,0!==o?1+c/(o/2):1,0!==n?1+c/(n/2):1)}getGroup(){return this.group}}class X{positions=[];indices=[];normals=[];uvs=[];geometry=new c;group=new h;constructor(e){if(!Array.isArray(e.polys))throw new Error("Format not supported yet!");e.normalized_uvs||(e.uvs=e?.uvs?.map((([t,o])=>[t/e.textureSize[0],o/e.textureSize[1]])));let t=0;for(const o of e.polys){for(const[t,n,i]of o)this.positions.push(...e?.positions?.[t]??[]),this.normals.push(...e?.normals?.[n]??[]),this.uvs.push(...e?.uvs?.[i]??[]);3===o.length?this.indices.push(t,t+1,t+2):this.indices.push(t+2,t+1,t,t+2,t,t+3),t+=o.length}this.createGeometry(),this.createMesh(e)}createGeometry(){this.geometry.setAttribute("position",new u(new Float32Array(this.positions),3)),this.geometry.setAttribute("normal",new u(new Float32Array(this.normals),3)),this.geometry.setAttribute("uv",new u(new Float32Array(this.uvs),2)),this.geometry.setIndex(this.indices)}createMesh({material:e}){const t=new m(this.geometry,e);this.group.add(t)}getGroup(){return this.group}}class Z{modelData;texturePath;model;boneMap=new Map;locators=new Map;animator=new I(this);constructor(e,t){this.modelData=e,this.texturePath=t;const o=e?.description?.identifier??"geometry.unknown";this.model=new h,this.model.name=o}async create(){const e=this.modelData,t=await this.loadTexture(this.texturePath),o=[e?.description?.texture_width??t.image.width,e?.description?.texture_height??t.image.height],n=[t.image.width/o[0],t.image.height/o[1]],i=new Map;t.magFilter=l,t.minFilter=l;const s=new d({side:p,alphaTest:.2,transparent:!0,map:t});e?.bones?.forEach((e=>{const t=new h;if(t.name=e.name??"unknown",e.poly_mesh){const n=new X({...e.poly_mesh,textureSize:o,material:s,mirror:e.mirror??!1,origin:[0,0,0],inflate:e.inflate,rotation:[0,0,0],pivot:e.pivot}).getGroup();n.name=`#bone.${e.name}#polyMesh`,t.add(n)}e.cubes?.forEach(((i,a)=>{const r=new U({width:i.size?.[0]??0,height:i.size?.[1]??0,depth:i.size?.[2]??0,startUV:i.uv,textureSize:o,textureDiscrepancyFactor:n,material:s,mirror:void 0===i.mirror&&void 0===i.rotation?e.mirror??!1:i.mirror??!1,origin:i.origin??[0,0,0],inflate:i.inflate??e.inflate,rotation:i.rotation,pivot:i.pivot??e.pivot}).getGroup();r.name=`#bone.${e.name}#cube.${a}`,t.add(r)}));const a=new h;if(a.rotation.order="ZYX",e.pivot){const[o,n,i]=e.pivot;a.position.set(-o,n,i),t.position.set(o,-n,-i)}else a.position.set(0,0,0);if(a.add(t),a.name="#pivot."+e.name,e.rotation){const[t,o,n]=e.rotation;a.rotation.set(r.degToRad(-t),r.degToRad(-o),r.degToRad(n))}const c=e.locators??{};for(const e in c){const t=new h;t.name="locator#"+e;const o=c[e];Array.isArray(o)?t.position.set(...o):"object"==typeof o&&(t.position.set(...o.offset??[0,0,0]),t.rotation.set(...o.rotation??[0,0,0])),this.locators.set(e,t),a.add(t)}e.parent||this.model.add(a),e.name&&(i.set(e.name,[e.parent,a]),this.boneMap.set(e.name,a))}));for(let[e,[t,o]]of i)if(t){const e=i.get(t)?.[1];e&&e.name.startsWith("#pivot.")?e.children[0].add(o):e&&e.add(o)}this.animator.setupDefaultBonePoses()}getGroup(){return this.model}getBoneMap(){return this.boneMap}getLocator(e){return this.locators.get(e)}tick(){this.animator.tick()}get shouldTick(){return this.animator.shouldTick}createOutlineBox(e,t,o){const n=new f({side:p,color:e,linewidth:20}),i=new g(o.x,o.y,o.z),s=new w(i),a=new b(s,n);return a.position.set(t.x,t.y+o.y/2,t.z),a.name="helperBox",this.model.add(a),{dispose:()=>{this.model.remove(a)}}}dispose(){this.animator.dispose()}loadTexture(e){return new Promise(((t,o)=>{(new E).load(e,(e=>{t(e)}))}))}}class q{canvasElement;texturePath;options;renderer;model;scene;camera;renderingRequested=!1;controls;loadedModel;constructor(e,t,o,n){this.canvasElement=e,this.texturePath=o,this.options=n,this.renderer=new y({canvas:e,antialias:n.antialias??!1}),this.renderer.setPixelRatio(window.devicePixelRatio),this.camera=new v(70,2,.1,1e3),this.camera.position.x=-20,this.camera.position.y=20,this.camera.position.z=-20,this.camera.updateProjectionMatrix(),this.controls=new _(this.camera,e),this.scene=new T,this.scene.add(new A(16777215)),this.scene.background=new M(13299960),this.model=new Z(t,o),this.scene.add(this.model.getGroup()),window.addEventListener("resize",this.onResize.bind(this)),this.controls.addEventListener("change",(()=>this.requestRendering())),this.onResize(),this.loadedModel=this.loadModel().then((()=>this.requestRendering()))}async loadModel(){await this.model.create()}get width(){return this.options.width??window.innerWidth}get height(){return this.options.height??window.innerHeight}render(e=!0){this.controls.update(),this.renderer.render(this.scene,this.camera),this.renderingRequested=!1,e&&this.model.shouldTick&&(this.model.tick(),this.model.animator.winterskyScene?.updateFacingRotation(this.camera),this.requestRendering())}requestRendering(e=!1){if(e)return this.render(!1);this.renderingRequested||(this.renderingRequested=!0,requestAnimationFrame((()=>this.render())))}onResize(){this.renderer.setSize(this.width,this.height,!0),this.camera.aspect=this.width/this.height,this.positionCamera(),this.requestRendering()}dispose(){window.removeEventListener("resize",this.onResize),this.controls.removeEventListener("change",this.requestRendering)}addHelpers(){this.scene.add(new k(50)),this.scene.add(new P(20,20)),this.scene.add(new O(this.model.getGroup(),16776960)),this.requestRendering()}getModel(){return this.model}positionCamera(e=1.5,t=!0){t&&this.model.getGroup().rotation.set(0,Math.PI,0);const o=(new x).setFromObject(this.model.getGroup()).getBoundingSphere(new R),n=this.camera.fov*Math.PI/180*e,i=o.radius/Math.tan(n/2),s=Math.sqrt(Math.pow(i,2)+Math.pow(i,2));this.camera.position.set(s,s,s),this.controls.update(),this.camera.lookAt(o.center),this.controls.target.set(o.center.x,o.center.y,o.center.z),this.camera.updateProjectionMatrix()}}export{Z as Model,q as StandaloneModelViewer};
